# 主控制器设计

<cite>
**本文档中引用的文件**  
- [hajimi_king.py](file://app/hajimi_king.py) - *新增 OpenRouter-only 模式支持*
- [config.py](file://common/config.py) - *新增 OPENROUTER 相关配置项*
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py) - *新增 OpenRouter 专用启动脚本*
</cite>

## 更新摘要
**变更内容**  
- 更新了主控制器对 OpenRouter API 密钥提取的支持
- 新增 `--mode` 命令行参数说明，支持三种运行模式
- 添加 `start_openrouter_only.py` 专用启动脚本的说明
- 修正数据处理流程以反映 OpenRouter 密钥提取逻辑
- 更新运行模式控制分支图示与说明
- 移除已废弃的 `sync_utils.py` 引用

### 目录
1. [项目结构](#项目结构)  
2. [核心组件](#核心组件)  
3. [主控制器架构概述](#主控制器架构概述)  
4. [详细组件分析](#详细组件分析)  
5. [数据处理流程](#数据处理流程)  
6. [运行模式与控制分支](#运行模式与控制分支)  
7. [错误处理与日志策略](#错误处理与日志策略)  
8. [依赖关系分析](#依赖关系分析)

## 项目结构

本项目采用模块化分层架构，核心功能由 `app`、`utils`、`common` 三大目录支撑，结构清晰，职责分明。新增 `start_openrouter_only.py` 作为专用启动入口。

```mermaid
graph TD
A[app/hajimi_king.py] --> B[common/config.py]
A --> C[common/Logger.py]
A --> D[utils/github_client.py]
A --> E[utils/file_manager.py]
D --> B
E --> B
E --> C
F[start_openrouter_only.py] --> A
F --> C
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

## 核心组件

项目由四大核心模块构成，协同完成密钥搜索、提取、验证与同步的全流程。

- **主控制器** (`hajimi_king.py`)：系统入口，协调各模块运行，现支持 OpenRouter 密钥提取。
- **配置管理器** (`config.py`)：集中管理所有运行时配置，新增 OpenRouter 相关参数。
- **GitHub客户端** (`github_client.py`)：封装GitHub API调用。
- **文件管理器** (`file_manager.py`)：负责文件读写与状态持久化。
- **专用启动脚本** (`start_openrouter_only.py`)：用于启动 OpenRouter 专用扫描模式。

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

## 主控制器架构概述

`hajimi_king.py` 作为系统核心，实现了从命令行解析到任务循环的完整控制流，现已扩展支持 OpenRouter API 密钥的提取。

```mermaid
sequenceDiagram
participant CLI as 命令行
participant Main as 主控制器
participant Config as 配置模块
participant GitHub as GitHub客户端
participant FileManager as 文件管理器
CLI->>Main : 启动程序
Main->>Config : 加载配置
Main->>FileManager : 初始化文件管理器
loop 持续扫描循环
Main->>FileManager : 获取搜索查询
Main->>GitHub : 执行搜索
loop 处理每个搜索结果
Main->>Main : 检查是否跳过
Main->>Main : 提取密钥Gemini/ms-key/OpenRouter
Main->>Main : 验证密钥仅Gemini
Main->>FileManager : 保存结果
end
Main->>FileManager : 保存检查点
end
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L357-L518)
- [file_manager.py](file://utils/file_manager.py)
- [github_client.py](file://utils/github_client.py)

## 详细组件分析

### 主控制器 (`hajimi_king.py`) 分析

主控制器通过 `main()` 函数驱动整个系统，其核心逻辑包括配置检查、循环扫描与异常处理。现已支持 `--mode` 参数控制提取行为。

#### 主函数执行流程

```mermaid
flowchart TD
Start([程序启动]) --> ParseArgs["解析命令行参数"]
ParseArgs --> CheckConfig["检查配置"]
CheckConfig --> CheckFileManager["检查文件管理器"]
CheckFileManager --> ShowInfo["显示系统信息"]
ShowInfo --> LoopStart["进入主循环"]
subgraph 主循环
LoopStart --> GetQueries["获取搜索查询"]
GetQueries --> ForEachQuery["遍历每个查询"]
subgraph 处理单个查询
ForEachQuery --> Search["GitHub搜索"]
Search --> ForEachItem["遍历每个搜索结果"]
subgraph 处理单个文件
ForEachItem --> ShouldSkip["检查是否跳过"]
ShouldSkip --> |是| Skip["跳过处理"]
ShouldSkip --> |否| Process["处理文件"]
Process --> SaveCheckpoint["保存检查点"]
end
ForEachItem --> UpdateStats["更新统计"]
end
ForEachQuery --> SaveQuery["标记查询已处理"]
ForEachQuery --> Break["每5个查询暂停"]
end
LoopStart --> Sleep["循环结束，休眠10秒"]
Sleep --> LoopStart
Start --> |用户中断| Shutdown["保存检查点并退出"]
Shutdown --> End([程序结束])
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L357-L518)

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L357-L518)

### 配置管理模块分析

`config.py` 模块通过 `Config` 类集中管理所有配置项，支持环境变量注入与类型转换，新增 OpenRouter 相关配置。

```mermaid
classDiagram
class Config {
+str GITHUB_TOKENS_STR
+list GITHUB_TOKENS
+str DATA_PATH
+list PROXY_LIST
+str GEMINI_BALANCER_URL
+str GPT_LOAD_URL
+str MODELSCOPE_EXTRACT_ONLY
+str OPENROUTER_BASE_URLS
+str OPENROUTER_EXTRACT_ONLY
+str OPENROUTER_USE_LOOSE_PATTERN
+int OPENROUTER_PROXIMITY_CHARS
+str OPENROUTER_REQUIRE_KEY_CONTEXT
+parse_bool(value) bool
+get_random_proxy() dict
+check() bool
}
```

**图示来源**  
- [config.py](file://common/config.py#L1-L204)

**本节来源**  
- [config.py](file://common/config.py#L1-L204)

## 数据处理流程

系统采用“搜索-提取-验证-同步”的流水线模式处理数据，现已支持 OpenRouter 密钥提取。

### 密钥提取与验证流程

```mermaid
flowchart TD
A[获取文件内容] --> B{是否配置了OPENROUTER_BASE_URLS?}
B --> |是| C[尝试提取OpenRouter密钥]
C --> D{是否找到sk-or-v1-?}
D --> |是| E[保存有效密钥]
D --> |否| F{是否配置了TARGET_BASE_URLS?}
F --> |是| G[尝试提取ModelScope密钥]
G --> H{是否找到ms-key?}
H --> |是| I[保存有效密钥]
H --> |否| J{是否启用MODELSCOPE_EXTRACT_ONLY?}
J --> |是| K[跳过Gemini提取]
J --> |否| L[提取Gemini密钥]
F --> |否| L
L --> M[过滤占位符密钥]
M --> N[验证每个密钥]
N --> O{验证结果}
O --> |有效| P[保存有效密钥]
O --> |限流| Q[保存限流密钥]
O --> |无效| R[丢弃]
P --> S[添加至同步队列]
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L213-L305)
- [config.py](file://common/config.py)

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L213-L305)

## 运行模式与控制分支

系统支持多种运行模式，通过 `--mode` 命令行参数或环境变量灵活控制行为。

### 运行模式控制逻辑

```mermaid
flowchart TD
A[启动] --> B[解析命令行参数]
B --> C{是否指定--mode?}
C --> |是| D[覆盖MODELSCOPE_EXTRACT_ONLY和OPENROUTER_EXTRACT_ONLY]
C --> |否| E[使用环境变量值]
D --> F
E --> F
F[主循环] --> G[处理文件]
G --> H{OPENROUTER_BASE_URLS存在?}
H --> |是| I[优先提取OpenRouter key]
I --> J{是否找到sk-or-v1-?}
J --> |是| K[保存并返回]
J --> |否| L{OPENROUTER_EXTRACT_ONLY为true?}
L --> |是| M[跳过其他提取]
L --> |否| N{TARGET_BASE_URLS存在?}
N --> |是| O[优先提取ms-key]
O --> P{是否找到ms-key?}
P --> |是| Q[保存并返回]
P --> |否| R{MODELSCOPE_EXTRACT_ONLY为true?}
R --> |是| S[跳过Gemini提取]
R --> |否| T[回退到Gemini提取]
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L357-L375)
- [config.py](file://common/config.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L357-L375)

## 错误处理与日志策略

系统具备完善的错误处理机制与日志记录策略，确保运行稳定可追踪。

### 异常处理流程

```mermaid
flowchart TD
A[主循环] --> B[处理查询]
B --> C[处理文件]
C --> D[网络请求]
D --> E{请求成功?}
E --> |是| F[继续处理]
E --> |否| G{HTTP状态码}
G --> |403/429| H[指数退避重试]
G --> |其他| I[记录错误，跳过]
A --> J{捕获异常?}
J --> |是| K[记录错误日志]
K --> L[继续循环]
J --> |否| M[正常执行]
A --> N{用户中断?}
N --> |是| O[保存检查点]
O --> P[退出]
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L488-L518)
- [github_client.py](file://utils/github_client.py)

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py#L488-L518)

## 依赖关系分析

系统各模块间依赖清晰，耦合度低，便于维护与扩展。

```mermaid
graph TD
hajimi_king --> config
hajimi_king --> github_client
hajimi_king --> file_manager
github_client --> config
file_manager --> config
file_manager --> Logger
start_openrouter_only --> hajimi_king
start_openrouter_only --> Logger
```

**图示来源**  
- [hajimi_king.py](file://app/hajimi_king.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

**本节来源**  
- [hajimi_king.py](file://app/hajimi_king.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)