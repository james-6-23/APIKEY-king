# 主控制器设计

<cite>
**本文档中引用的文件**  
- [main.py](file://src\main.py) - *重构为主应用类设计，替代旧版hajimi_king.py*
- [config.py](file://src\models\config.py) - *更新为数据类配置模型*
- [config_service.py](file://src\services\config_service.py) - *重构配置加载服务*
- [github_service.py](file://src\services\github_service.py) - *更新为服务类实现*
- [scanner.py](file://src\core\scanner.py) - *新增核心扫描器模块*
</cite>

## 更新摘要
**变更内容**  
- 主控制器重构为 `Application` 类，采用模块化初始化与扫描循环
- 新增 `ScanMode` 枚举支持多种运行模式（兼容、仅OpenRouter、仅ModelScope、仅Gemini）
- 配置系统重构为基于数据类的 `AppConfig` 模型，提升类型安全
- 服务层拆分为 `ConfigService`、`GitHubService`、`FileService` 等独立服务类
- 移除已废弃的 `hajimi_king.py`，主入口迁移至 `src/main.py`
- 更新数据处理流程以反映新的提取器与验证器管理机制
- 修正运行模式控制逻辑以匹配新配置结构

### 目录
1. [项目结构](#项目结构)  
2. [核心组件](#核心组件)  
3. [主控制器架构概述](#主控制器架构概述)  
4. [详细组件分析](#详细组件分析)  
5. [数据处理流程](#数据处理流程)  
6. [运行模式与控制分支](#运行模式与控制分支)  
7. [错误处理与日志策略](#错误处理与日志策略)  
8. [依赖关系分析](#依赖关系分析)

## 项目结构

本项目采用模块化分层架构，核心功能由 `src/core`、`src/services`、`src/models`、`src/extractors`、`src/validators` 五大模块支撑，结构清晰，职责分明。主入口已迁移至 `src/main.py`。

```mermaid
graph TD
A[src/main.py] --> B[src/models/config.py]
A --> C[src/services/config_service.py]
A --> D[src/services/github_service.py]
A --> E[src/services/file_service.py]
A --> F[src/core/scanner.py]
D --> B
E --> B
F --> B
```

**图示来源**  
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)

## 核心组件

项目由五大核心模块构成，协同完成密钥搜索、提取、验证与同步的全流程。

- **主控制器** (`main.py`)：系统入口，基于 `Application` 类驱动整个流程。
- **配置模型** (`config.py`)：定义 `AppConfig` 等数据类，集中管理运行时配置。
- **配置服务** (`config_service.py`)：负责加载 `default.yaml` 与环境变量，构建配置对象。
- **GitHub服务** (`github_service.py`)：封装GitHub API调用，支持多令牌轮换与代理。
- **文件服务** (`file_service.py`)：管理查询、检查点与扫描结果的持久化。
- **核心扫描器** (`scanner.py`)：协调提取器与验证器，执行内容扫描。

**本节来源**  
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)
- [scanner.py](file://src\core\scanner.py)

## 主控制器架构概述

`main.py` 中的 `Application` 类作为系统核心，实现了从命令行解析到任务循环的完整控制流，采用面向对象设计提升可维护性。

```mermaid
sequenceDiagram
participant CLI as 命令行
participant App as Application
participant ConfigSvc as ConfigService
participant GitHubSvc as GitHubService
participant FileSvc as FileService
CLI->>App : 启动程序
App->>ConfigSvc : 加载配置
App->>App : 应用扫描模式
App->>GitHubSvc : 初始化
App->>FileSvc : 初始化
App->>App : 创建提取器与验证器
loop 持续扫描循环
App->>FileSvc : 加载查询
App->>GitHubSvc : 执行搜索
loop 处理每个搜索结果
App->>App : 检查是否跳过
App->>App : 调用扫描器处理内容
App->>FileSvc : 保存检查点
end
App->>FileSvc : 保存批次结果
end
```

**图示来源**  
- [main.py](file://src\main.py#L150-L450)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)

## 详细组件分析

### 主控制器 (`main.py`) 分析

主控制器通过 `Application` 类和 `main()` 函数驱动整个系统，其核心逻辑包括配置初始化、扫描模式应用与主循环调度。

#### 主函数执行流程

```mermaid
flowchart TD
Start([程序启动]) --> ParseArgs["解析命令行参数"]
ParseArgs --> CreateApp["创建Application实例"]
CreateApp --> InitApp["调用app.run()"]
InitApp --> Initialize["执行initialize()"]
Initialize --> LoadConfig["加载配置"]
LoadConfig --> ApplyMode["应用扫描模式"]
ApplyMode --> InitServices["初始化服务"]
InitServices --> CreateExtractors["创建提取器"]
CreateExtractors --> CreateValidators["创建验证器"]
CreateValidators --> LoadCheckpoint["加载检查点"]
LoadCheckpoint --> RunLoop["进入主循环"]
subgraph 主循环
RunLoop --> LoadQueries["加载查询"]
LoadQueries --> ForEachQuery["遍历每个查询"]
subgraph 处理单个查询
ForEachQuery --> Search["GitHub搜索"]
Search --> ForEachItem["遍历每个搜索结果"]
subgraph 处理单个文件
ForEachItem --> ShouldSkip["检查是否跳过"]
ShouldSkip --> |是| Skip["跳过处理"]
ShouldSkip --> |否| ScanContent["调用_scan_item扫描"]
ScanContent --> UpdateCheckpoint["更新检查点"]
end
ForEachItem --> UpdateStats["更新统计"]
end
ForEachQuery --> MarkQuery["标记查询已处理"]
ForEachQuery --> SaveCheckpoint["保存检查点"]
end
RunLoop --> SaveBatch["保存批次结果"]
RunLoop --> Sleep["休眠10秒"]
Sleep --> RunLoop
InitApp --> |用户中断| Shutdown["保存检查点并退出"]
Shutdown --> End([程序结束])
```

**图示来源**  
- [main.py](file://src\main.py#L150-L450)

**本节来源**  
- [main.py](file://src\main.py#L150-L450)

### 配置管理模块分析

`config.py` 模块通过 `AppConfig` 数据类集中管理所有配置项，支持嵌套配置结构与类型安全，取代旧版字典式配置。

```mermaid
classDiagram
class AppConfig {
+str data_path
+list proxy_list
+GitHubConfig github
+ScanConfig scan
+Dict[str, ExtractorConfig] extractors
+Dict[str, ValidatorConfig] validators
+get_proxy_configs() List[ProxyConfig]
+get_enabled_extractors() Dict[str, ExtractorConfig]
+get_enabled_validators() Dict[str, ValidatorConfig]
}
class GitHubConfig {
+list tokens
+str api_url
}
class ScanConfig {
+int date_range_days
+list file_path_blacklist
+str queries_file
}
class ExtractorConfig {
+str name
+bool enabled
+Dict[str, str] patterns
+list base_urls
+bool use_loose_pattern
+int proximity_chars
+bool require_key_context
+bool extract_only
}
class ValidatorConfig {
+str name
+bool enabled
+str api_endpoint
+str model_name
+float timeout
}
AppConfig --> GitHubConfig
AppConfig --> ScanConfig
AppConfig --> ExtractorConfig
AppConfig --> ValidatorConfig
```

**图示来源**  
- [config.py](file://src\models\config.py#L1-L112)

**本节来源**  
- [config.py](file://src\models\config.py#L1-L112)

## 数据处理流程

系统采用“搜索-提取-验证-同步”的流水线模式处理数据，通过 `APIKeyScanner` 统一调度提取器与验证器。

### 密钥提取与验证流程

```mermaid
flowchart TD
A[获取文件内容] --> B[创建扫描上下文]
B --> C[调用APIKeyScanner.scan_content]
C --> D{遍历所有启用的提取器}
D --> E[执行提取器.extract_keys]
E --> F{是否找到密钥?}
F --> |是| G[收集提取结果]
F --> |否| H[继续下一个提取器]
D --> I[所有提取器完成]
I --> J{是否有密钥被提取?}
J --> |否| K[返回空结果]
J --> |是| L{遍历所有启用的验证器}
L --> M[执行验证器.validate_keys]
M --> N{验证结果}
N --> |有效| O[标记为有效密钥]
N --> |限流| P[标记为限流]
N --> |无效| Q[标记为无效]
L --> R[所有验证器完成]
R --> S[构建ScanResult对象]
S --> T[返回扫描结果]
```

**图示来源**  
- [main.py](file://src\main.py#L300-L350)
- [scanner.py](file://src\core\scanner.py)
- [config.py](file://src\models\config.py)

**本节来源**  
- [main.py](file://src\main.py#L300-L350)

## 运行模式与控制分支

系统支持多种运行模式，通过 `--mode` 命令行参数或环境变量灵活控制行为，由 `Application._apply_scan_mode_config` 方法实现。

### 运行模式控制逻辑

```mermaid
flowchart TD
A[启动] --> B[解析命令行参数]
B --> C{是否指定--mode?}
C --> |是| D[创建Application时传入ScanMode]
C --> |否| E[使用默认COMPATIBLE模式]
D --> F[Application.initialize]
E --> F
F --> G[调用_apply_scan_mode_config]
G --> H{模式判断}
H --> |OPENROUTER_ONLY| I[启用OpenRouter提取器与验证器]
H --> |MODELSCOPE_ONLY| J[启用ModelScope提取器与验证器]
H --> |GEMINI_ONLY| K[启用Gemini提取器与验证器]
H --> |COMPATIBLE| L[启用所有提取器与验证器]
I --> M[设置查询文件为openrouter.txt]
J --> N[设置查询文件为modelscope.txt]
K --> O[设置查询文件为gemini.txt]
L --> P[设置查询文件为默认或配置值]
M --> Q[继续初始化]
N --> Q
O --> Q
P --> Q
```

**图示来源**  
- [main.py](file://src\main.py#L100-L145)
- [config_service.py](file://src\services\config_service.py)
- [config.py](file://src\models\config.py)

**本节来源**  
- [main.py](file://src\main.py#L100-L145)

## 错误处理与日志策略

系统具备完善的错误处理机制与日志记录策略，确保运行稳定可追踪。

### 异常处理流程

```mermaid
flowchart TD
A[主循环] --> B[处理查询]
B --> C[处理文件]
C --> D[网络请求]
D --> E{请求成功?}
E --> |是| F[继续处理]
E --> |否| G{HTTP状态码}
G --> |403/429| H[指数退避重试]
G --> |其他| I[记录错误，跳过]
A --> J{捕获异常?}
J --> |是| K[记录错误日志]
K --> L[继续循环]
J --> |否| M[正常执行]
A --> N{用户中断?}
N --> |是| O[保存检查点]
O --> P[退出]
```

**图示来源**  
- [main.py](file://src\main.py#L400-L450)
- [github_service.py](file://src\services\github_service.py)

**本节来源**  
- [main.py](file://src\main.py#L400-L450)

## 依赖关系分析

系统各模块间依赖清晰，耦合度低，便于维护与扩展。

```mermaid
graph TD
main.py --> models/config.py
main.py --> services/config_service.py
main.py --> services/github_service.py
main.py --> services/file_service.py
main.py --> core/scanner.py
config_service.py --> models/config.py
github_service.py --> models/config.py
file_service.py --> models/config.py
core/scanner.py --> extractors/base.py
core/scanner.py --> validators/base.py
```

**图示来源**  
- [main.py](file://src\main.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)
- [scanner.py](file://src\core\scanner.py)

**本节来源**  
- [main.py](file://src\main.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)
- [scanner.py](file://src\core\scanner.py)