# 代码架构与模块设计

<cite>
**本文档中引用的文件**   
- [main.py](file://src\main.py) - *重构后的新主入口文件*
- [config.py](file://src\models\config.py) - *配置模型重构*
- [logger.py](file://src\utils\logger.py) - *日志系统升级*
- [config_service.py](file://src\services\config_service.py) - *配置服务实现*
- [github_service.py](file://src\services\github_service.py) - *GitHub服务封装*
- [file_service.py](file://src\services\file_service.py) - *文件服务实现*
- [scanner.py](file://src\core\scanner.py) - *核心扫描器*
</cite>

## 更新摘要
**变更内容**   
- 项目架构重构，核心代码迁移至src目录，采用模块化设计
- 主入口文件从app/hajimi_king.py迁移至src/main.py
- 配置系统重构，使用dataclass实现类型安全的配置模型
- 新增services层，分离配置、GitHub、文件操作等服务
- 核心扫描逻辑迁移至core/scanner.py
- 日志系统升级，支持双语输出和增强功能
- 移除旧的同步功能相关组件
- 新增对OpenRouter API密钥提取功能的支持，通过命令行参数`--mode openrouter-only`启用

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [依赖关系分析](#依赖关系分析)
6. [性能考量](#性能考量)
7. [故障排除指南](#故障排除指南)
8. [结论](#结论)

## 项目结构

项目采用清晰的分层模块化设计，各目录职责分明，便于维护和扩展。

```mermaid
graph TD
subgraph "src"
A[main.py<br/>主应用入口]
B[core<br/>核心逻辑]
C[models<br/>数据模型]
D[services<br/>业务服务]
E[utils<br/>工具类]
F[extractors<br/>密钥提取器]
G[validators<br/>密钥验证器]
end
A --> B
A --> C
A --> D
A --> E
A --> F
A --> G
B --> C
B --> F
B --> G
D --> C
D --> E
```

**图示来源**
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)
- [logger.py](file://src\utils\logger.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)

**本节来源**
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)

## 核心组件

本项目由多个核心组件构成，共同实现API密钥扫描功能。

- **main.py**：主应用入口，协调所有模块，实现核心业务逻辑。
- **config.py**：配置模型，使用dataclass定义类型安全的配置结构。
- **logger.py**：统一日志接口，支持双语输出，贯穿所有模块。
- **config_service.py**：配置服务，负责加载和管理应用配置。
- **github_service.py**：GitHub服务，封装GitHub API调用。
- **file_service.py**：文件服务，管理扫描状态、检查点和文件I/O。
- **scanner.py**：核心扫描器，协调提取器和验证器处理内容。

**本节来源**
- [main.py](file://src\main.py#L1-L451)
- [config.py](file://src\models\config.py#L1-L111)
- [logger.py](file://src\utils\logger.py#L1-L259)

## 架构概述

系统采用分层架构，`main.py`作为主控制器，通过`config_service`加载配置，`github_service`进行搜索，`file_service`管理状态。

```mermaid
sequenceDiagram
participant Main as main.py<br/>主应用
participant ConfigSvc as config_service.py<br/>配置服务
participant Logger as logger.py<br/>日志
participant GitHubSvc as github_service.py<br/>GitHub服务
participant FileSvc as file_service.py<br/>文件服务
participant Scanner as scanner.py<br/>扫描器
Main->>ConfigSvc : load_config(加载配置)
Main->>Logger : 初始化日志
Main->>FileSvc : load_checkpoint(加载检查点)
Main->>GitHubSvc : search_code(搜索代码)
GitHubSvc-->>Main : 返回搜索结果
loop 处理每个文件
Main->>Main : _should_skip_item(检查跳过)
alt 应跳过
Main->>Main : 记录跳过统计
else 不跳过
Main->>GitHubSvc : get_file_content(获取内容)
Main->>Scanner : scan_content(扫描内容)
Scanner->>Scanner : 调用提取器
Scanner->>Scanner : 调用验证器
Scanner-->>Main : 返回扫描结果
Main->>FileSvc : save_scan_result(保存结果)
Main->>FileSvc : save_checkpoint(保存检查点)
end
end
```

**图示来源**
- [main.py](file://src\main.py#L1-L451)
- [config_service.py](file://src\services\config_service.py#L1-L215)
- [logger.py](file://src\utils\logger.py#L1-L259)
- [github_service.py](file://src\services\github_service.py#L1-L255)
- [file_service.py](file://src\services\file_service.py#L1-L216)
- [scanner.py](file://src\core\scanner.py)

## 详细组件分析

### 主控制器分析 (main.py)

`main.py`是整个应用的入口和协调中心，负责调度所有其他模块。

#### 核心流程
```mermaid
flowchart TD
Start([开始]) --> Init["初始化应用组件"]
Init --> LoadConfig["加载配置"]
LoadConfig --> CreateServices["创建服务实例"]
CreateServices --> CreateScanner["创建扫描器"]
CreateScanner --> LoadQueries["加载查询"]
LoadQueries --> Loop["进入主循环"]
subgraph "主循环"
Loop --> ProcessQuery["处理每个查询"]
ProcessQuery --> Search["调用GitHubService.search_code"]
Search --> CheckItems["检查是否有items"]
CheckItems --> |否| NextQuery["下一个查询"]
CheckItems --> |是| ProcessItem["遍历每个item"]
ProcessItem --> SkipCheck["_should_skip_item检查"]
SkipCheck --> |是| SkipLog["记录跳过原因"]
SkipCheck --> |否| GetContent["get_file_content获取文件内容"]
GetContent --> ScanContent["调用APIKeyScanner.scan_content"]
ScanContent --> SaveResult["save_scan_result保存结果"]
SaveResult --> UpdateCP["add_scanned_sha记录SHA"]
UpdateCP --> NextItem["下一个item"]
NextItem --> |未完成| ProcessItem
NextItem --> |完成| SaveCP["save_checkpoint保存检查点"]
SaveCP --> NextQuery
NextQuery --> |未完成| ProcessQuery
NextQuery --> |完成| LogStats["记录循环统计"]
end
Loop --> |用户中断| SaveFinal["保存最终检查点"]
SaveFinal --> End([结束])
```

**图示来源**
- [main.py](file://src\main.py#L1-L451)

**本节来源**
- [main.py](file://src\main.py#L1-L451)

### 配置管理分析 (config.py)

`config.py`使用dataclass实现类型安全的配置模型，集中管理所有配置。

#### 配置类结构
```mermaid
classDiagram
class AppConfig {
+str data_path
+List[str] proxy_list
+GitHubConfig github
+ScanConfig scan
+Dict[str, ExtractorConfig] extractors
+Dict[str, ValidatorConfig] validators
+get_proxy_configs() List[ProxyConfig]
+get_enabled_extractors() Dict[str, ExtractorConfig]
+get_enabled_validators() Dict[str, ValidatorConfig]
}
class GitHubConfig {
+List[str] tokens
+str api_url
}
class ScanConfig {
+int date_range_days
+List[str] file_path_blacklist
+str queries_file
}
class ExtractorConfig {
+str name
+bool enabled
+Dict[str, str] patterns
+List[str] base_urls
+bool use_loose_pattern
+int proximity_chars
+bool require_key_context
+bool extract_only
}
class ValidatorConfig {
+str name
+bool enabled
+str api_endpoint
+str model_name
+float timeout
}
AppConfig "1" --> "1" GitHubConfig : 包含
AppConfig "1" --> "1" ScanConfig : 包含
AppConfig "1" --> "many" ExtractorConfig : 包含
AppConfig "1" --> "many" ValidatorConfig : 包含
```

**图示来源**
- [config.py](file://src\models\config.py#L1-L111)

**本节来源**
- [config.py](file://src\models\config.py#L1-L111)

### 文件与状态管理分析 (file_service.py)

`file_service.py`负责持久化存储、检查点管理和文件I/O操作。

#### 核心数据结构
```mermaid
classDiagram
class Checkpoint {
+Optional[str] last_scan_time
+Set[str] scanned_shas
+Set[str] processed_queries
+to_dict() Dict[str, Any]
+from_dict(data Dict) Checkpoint
+add_scanned_sha(sha str) None
+add_processed_query(query str) None
+update_scan_time() None
}
class FileService {
-Path data_path
-Path checkpoint_file
-Path scanned_shas_file
+__init__(data_path str) None
+load_checkpoint() Checkpoint
+save_checkpoint(cp Checkpoint) None
+load_scanned_shas() Set[str]
+save_scanned_shas(shas Set[str]) None
+load_queries(path str) List[str]
+save_scan_result(result ScanResult) None
+save_batch_result(result BatchScanResult) None
}
Checkpoint "1" -- "1" FileService : "被包含"
FileService "1" -- "1" Checkpoint : "加载/保存"
```

**图示来源**
- [file_service.py](file://src\services\file_service.py#L1-L216)

**本节来源**
- [file_service.py](file://src\services\file_service.py#L1-L216)

### GitHub服务分析 (github_service.py)

`github_service.py`封装了对GitHub API的所有调用，提供高可用的搜索和文件获取功能。

#### API调用流程
```mermaid
sequenceDiagram
participant Service as GitHubService
participant Request as requests
participant GitHubAPI as GitHub API
Service->>Service : search_code(查询)
loop 1-10页
Service->>Service : _get_next_token(获取Token)
Service->>Request : GET /search/code
Request->>GitHubAPI : 发送请求
GitHubAPI-->>Request : 返回响应
alt 响应成功
Request-->>Service : 返回JSON
Service->>Service : 解析items并累加
Service->>Service : 随机休眠
else 响应失败
alt 状态码403/429
Service->>Service : 指数退避重试
else 其他错误
Service->>Service : 网络错误重试
end
end
end
Service-->>Service : 返回所有items
Service->>Service : get_file_content(item)
Service->>Service : _get_next_token(获取Token)
Service->>Request : GET /repos/{repo}/contents/{path}
Request->>GitHubAPI : 发送请求
alt 响应成功
GitHubAPI-->>Request : 返回元数据
Request-->>Service : 返回JSON
Service->>Service : 检查encoding
alt encoding为base64
Service->>Service : base64.b64decode解码
else 有download_url
Service->>Request : GET download_url
Request->>GitHubAPI : 发送请求
GitHubAPI-->>Request : 返回文件内容
Request-->>Service : 返回文本
end
else 响应失败
Service->>Service : 记录错误并返回None
end
Service-->>Service : 返回文件内容
```

**图示来源**
- [github_service.py](file://src\services\github_service.py#L1-L255)

**本节来源**
- [github_service.py](file://src\services\github_service.py#L1-L255)

## 依赖关系分析

系统各模块间依赖关系清晰，耦合度低。

```mermaid
graph TD
A[main.py] --> B[config.py]
A --> C[logger.py]
A --> D[config_service.py]
A --> E[github_service.py]
A --> F[file_service.py]
A --> G[scanner.py]
D --> B
E --> B
F --> B
G --> B
G --> H[extractors]
G --> I[validators]
```

**图示来源**
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)
- [logger.py](file://src\utils\logger.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)
- [scanner.py](file://src\core\scanner.py)

**本节来源**
- [main.py](file://src\main.py)
- [config.py](file://src\models\config.py)
- [config_service.py](file://src\services\config_service.py)
- [github_service.py](file://src\services\github_service.py)
- [file_service.py](file://src\services\file_service.py)

## 性能考量

系统在设计上考虑了性能和稳定性：

1. **请求节流**：`github_service.py`在每页请求后随机休眠0.5-1.5秒，避免触发速率限制。
2. **指数退避**：当遇到403/429错误时，使用指数退避策略进行重试。
3. **增量扫描**：通过`checkpoint`机制，支持断点续传，避免重复扫描。
4. **智能过滤**：通过`FILE_PATH_BLACKLIST`过滤文档和示例文件，提高扫描效率。
5. **多Token轮换**：支持多个GitHub Token自动轮换，提高扫描效率和稳定性。

## 故障排除指南

### 常见问题

**GitHub API 调用失败**
- **现象**：日志中出现`HTTP 403`或`HTTP 429`错误。
- **原因**：Token无效或速率限制。
- **解决方案**：检查`GITHUB_TOKENS`配置，确保Token具有`public_repo`权限，并考虑增加Token数量或使用代理。

**无法获取文件内容**
- **现象**：日志中出现`Failed to fetch file content`。
- **原因**：网络问题或GitHub API临时故障。
- **解决方案**：检查网络连接，或配置`PROXY`使用代理。

**OpenRouter密钥未被提取**
- **现象**：已知包含OpenRouter密钥的文件未被识别。
- **原因**：`OPENROUTER_BASE_URLS`配置不正确或`OPENROUTER_EXTRACT_ONLY`模式未启用。
- **解决方案**：检查`OPENROUTER_BASE_URLS`环境变量，确保包含`https://openrouter.ai/api/v1`等目标URL。

**本节来源**
- [main.py](file://src\main.py#L1-L451)
- [github_service.py](file://src\services\github_service.py#L1-L255)

## 结论

本项目采用模块化设计，代码结构清晰，职责分明。`main.py`作为主控制器，通过`config_service.py`获取配置，利用`github_service.py`进行API调用，通过`file_service.py`管理状态和文件。这种设计使得系统易于维护和扩展。日志系统贯穿所有模块，便于调试和监控。整体架构合理，性能和稳定性得到了充分考虑。新增的OpenRouter密钥提取功能通过命令行参数灵活控制，增强了系统的适用性。