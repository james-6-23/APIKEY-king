# 开发者指南

<cite>
**本文档中引用的文件**   
- [hajimi_king.py](file://app/hajimi_king.py) - *已移除同步功能，新增OpenRouter密钥提取支持*
- [config.py](file://common/config.py) - *已移除同步相关配置，新增OpenRouter配置项*
- [Logger.py](file://common/Logger.py) - *重构日志模块，提升日志输出体验和功能*
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py) - *已移除keys_send相关方法*
- [dry_run.py](file://scripts/dry_run.py)
- [start_openrouter_only.py](file://start_openrouter_only.py) - *新增OpenRouter专用启动脚本*
</cite>

## 更新摘要
**变更内容**   
- 新增OpenRouter API密钥提取功能，支持通过配置控制提取行为
- 在`hajimi_king.py`中添加`extract_openrouter_keys`函数，实现OpenRouter密钥提取逻辑
- 在`config.py`中添加OpenRouter相关配置项，包括`OPENROUTER_BASE_URLS`、`OPENROUTER_EXTRACT_ONLY`等
- 添加`start_openrouter_only.py`专用启动脚本，支持仅扫描OpenRouter密钥的模式
- 更新“核心组件”和“详细组件分析”章节，反映新增的OpenRouter功能
- 所有引用和图表均已更新以反映最新的代码状态

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概览](#架构概览)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)
6. [测试策略](#测试策略)
7. [贡献流程](#贡献流程)

## 项目结构

本项目采用模块化分层架构，各目录职责明确，便于维护和扩展。

```mermaid
graph TB
subgraph "app"
A[hajimi_king.py]
end
subgraph "common"
B[Logger.py]
C[config.py]
end
subgraph "utils"
D[github_client.py]
E[file_manager.py]
end
subgraph "scripts"
F[dry_run.py]
end
A --> B
A --> C
A --> D
A --> E
F --> C
F --> E
G[start_openrouter_only.py] --> A
G --> C
```

**图示来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [Logger.py](file://common/Logger.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [dry_run.py](file://scripts/dry_run.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

**本节来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)

## 核心组件

项目由多个核心组件构成，共同完成API密钥扫描任务。

- **app/hajimi_king.py**: 主程序入口，协调各组件工作流程，新增OpenRouter密钥提取功能
- **common/config.py**: 配置管理，集中处理环境变量和运行时配置，新增OpenRouter相关配置
- **common/Logger.py**: 日志系统，提供统一的日志输出接口
- **utils/github_client.py**: GitHub API客户端，负责搜索和获取文件内容
- **utils/file_manager.py**: 文件管理器，处理所有文件读写和检查点管理
- **start_openrouter_only.py**: OpenRouter专用启动脚本，支持仅扫描OpenRouter密钥的模式

这些组件通过清晰的接口进行交互，实现了高内聚、低耦合的设计目标。

**本节来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [Logger.py](file://common/Logger.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

## 架构概览

系统采用主循环驱动的架构模式，通过增量扫描机制持续发现新的API密钥，支持多种密钥类型的提取。

```mermaid
sequenceDiagram
participant Main as 主程序
participant GitHub as GitHub客户端
participant FileManager as 文件管理器
Main->>FileManager : 加载检查点
Main->>GitHub : 搜索密钥
loop 每个搜索结果
Main->>Main : 检查是否跳过
alt 应跳过
Main->>Main : 记录跳过统计
else 不跳过
Main->>GitHub : 获取文件内容
Main->>Main : 提取密钥
alt 包含ModelScope base_url
Main->>Main : 提取ModelScope密钥(ms-uuid)
else 包含OpenRouter base_url
Main->>Main : 提取OpenRouter密钥(sk-or-v1-*)
else 启用仅提取模式
Main->>Main : 跳过Gemini提取
else
Main->>Main : 提取Gemini密钥并验证
end
alt 密钥有效
Main->>FileManager : 保存有效密钥
else 被限流
Main->>FileManager : 保存限流密钥
end
Main->>FileManager : 记录已扫描SHA
end
end
Main->>FileManager : 保存检查点
```

**图示来源**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L595)
- [github_client.py](file://utils/github_client.py#L1-L217)
- [file_manager.py](file://utils/file_manager.py#L1-L431)

## 详细组件分析

### 主程序分析

`hajimi_king.py` 是系统的核心控制器，负责协调各个组件完成扫描任务，现已支持OpenRouter密钥提取。

#### 主要功能流程

```mermaid
flowchart TD
Start([程序启动]) --> ConfigCheck["检查配置有效性"]
ConfigCheck --> FileCheck["检查文件管理器"]
FileCheck --> SystemInfo["显示系统信息"]
SystemInfo --> LoopStart["进入主循环"]
LoopStart --> QueryLoop["遍历每个查询"]
QueryLoop --> CheckProcessed["检查是否已处理"]
CheckProcessed --> |已处理| SkipQuery["跳过查询"]
CheckProcessed --> |未处理| SearchGitHub["搜索GitHub"]
SearchGitHub --> ProcessItems["处理搜索结果"]
ProcessItems --> CheckSkip["检查是否应跳过"]
CheckSkip --> |应跳过| SkipItem["记录跳过原因"]
CheckSkip --> |不应跳过| GetContent["获取文件内容"]
GetContent --> ExtractOpenRouter["检查OpenRouter base_url"]
ExtractOpenRouter --> |存在| ExtractOpenRouterKeys["提取OpenRouter密钥"]
ExtractOpenRouter --> |不存在| ExtractModelScope["检查ModelScope base_url"]
ExtractModelScope --> |存在| ExtractMSKeys["提取ModelScope密钥"]
ExtractModelScope --> |不存在| CheckExtractOnly["检查仅提取模式"]
CheckExtractOnly --> |启用| SkipGemini["跳过Gemini提取"]
CheckExtractOnly --> |禁用| ExtractGemini["提取Gemini密钥"]
ExtractGemini --> ValidateKeys["验证密钥有效性"]
ValidateKeys --> SaveValid["保存有效密钥"]
ValidateKeys --> SaveLimited["保存限流密钥"]
SaveValid --> RecordSHA["记录已扫描SHA"]
SaveLimited --> RecordSHA
RecordSHA --> NextItem["处理下一个项目"]
NextItem --> |完成| UpdateCheckpoint["更新检查点"]
UpdateCheckpoint --> NextQuery["下一个查询"]
NextQuery --> |完成| Sleep["休眠10秒"]
Sleep --> LoopStart
SkipQuery --> NextQuery
SkipItem --> NextItem
ExtractOpenRouterKeys --> SaveValid
ExtractMSKeys --> SaveValid
style Start fill:#9f9,stroke:#333
style SaveValid fill:#9f9,stroke:#333
style SaveLimited fill:#f96,stroke:#333
style RecordSHA fill:#bbf,stroke:#333
style UpdateCheckpoint fill:#f9f,stroke:#333
```

**图示来源**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L595)

#### 核心方法说明

- **main()**: 主程序入口，包含主循环逻辑，支持命令行参数配置提取模式
- **process_item()**: 处理单个GitHub搜索结果的核心方法，优先尝试提取ModelScope或OpenRouter密钥
- **validate_gemini_key()**: 验证Gemini API密钥有效性的方法
- **should_skip_item()**: 判断是否应跳过处理某个项目的决策方法
- **extract_openrouter_keys()**: 新增方法，提取OpenRouter API密钥
- **_parse_cli_args()**: 解析命令行参数，支持配置提取模式

**本节来源**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L595)

### 配置管理分析

`config.py` 模块负责管理所有运行时配置，提供类型安全的配置访问，现已支持OpenRouter相关配置。

#### 配置类结构

```mermaid
classDiagram
class Config {
+str GITHUB_TOKENS_STR
+List[str] GITHUB_TOKENS
+str DATA_PATH
+List[str] PROXY_LIST
+str VALID_KEY_PREFIX
+str RATE_LIMITED_KEY_PREFIX
+str VALID_KEY_DETAIL_PREFIX
+str RATE_LIMITED_KEY_DETAIL_PREFIX
+int DATE_RANGE_DAYS
+str QUERIES_FILE
+str SCANNED_SHAS_FILE
+str HAJIMI_CHECK_MODEL
+List[str] FILE_PATH_BLACKLIST
+List[str] TARGET_BASE_URLS
+str MS_USE_LOOSE_PATTERN
+int MS_PROXIMITY_CHARS
+str MS_REQUIRE_KEY_CONTEXT
+str MODELSCOPE_EXTRACT_ONLY
+List[str] OPENROUTER_BASE_URLS
+str OPENROUTER_USE_LOOSE_PATTERN
+int OPENROUTER_PROXIMITY_CHARS
+str OPENROUTER_REQUIRE_KEY_CONTEXT
+str OPENROUTER_EXTRACT_ONLY
+parse_bool(value str) bool
+get_random_proxy() Dict[str, str]
+check() bool
}
```

**图示来源**
- [config.py](file://common/config.py#L1-L188)

#### 配置加载流程

```mermaid
flowchart TD
Start([程序启动]) --> LoadEnv["加载.env文件"]
LoadEnv --> ParseTokens["解析GitHub令牌"]
ParseTokens --> ParseProxy["解析代理列表"]
ParseProxy --> FilePrefixConfig["加载文件前缀配置"]
FilePrefixConfig --> DateRangeConfig["加载日期范围配置"]
DateRangeConfig --> QueryFileConfig["加载查询文件配置"]
QueryFileConfig --> ModelConfig["加载模型配置"]
ModelConfig --> BlacklistConfig["加载文件路径黑名单"]
BlacklistConfig --> ModelScopeConfig["加载ModelScope提取配置"]
ModelScopeConfig --> OpenRouterConfig["加载OpenRouter提取配置"]
OpenRouterConfig --> LogConfig["记录配置信息"]
LogConfig --> CreateInstance["创建全局配置实例"]
style Start fill:#9f9,stroke:#333
style CreateInstance fill:#9f9,stroke:#333
```

**图示来源**
- [config.py](file://common/config.py#L1-L188)

**本节来源**
- [config.py](file://common/config.py#L1-L188)

### GitHub客户端分析

`github_client.py` 模块封装了与GitHub API的交互逻辑。

#### 类结构

```mermaid
classDiagram
class GitHubClient {
+str GITHUB_API_URL
-List[str] tokens
-int _token_ptr
+search_for_keys(query str, max_retries int) Dict[str, Any]
+get_file_content(item Dict[str, Any]) str
+create_instance(tokens List[str]) GitHubClient
-_next_token() str
}
```

**图示来源**
- [github_client.py](file://utils/github_client.py#L1-L217)

#### 搜索流程

```mermaid
sequenceDiagram
participant Client as GitHub客户端
participant API as GitHub API
participant Logger as 日志系统
Client->>Client : 初始化请求参数
loop 最多10页
Client->>Client : 获取下一个令牌
Client->>API : 发送搜索请求
alt 请求成功
API-->>Client : 返回搜索结果
Client->>Client : 解析结果并合并
Client->>Logger : 记录成功日志
alt 不是最后一页
Client->>Client : 随机休眠
end
else 请求失败
alt 状态码403/429
Client->>Client : 指数退避重试
else 其他错误
Client->>Client : 网络错误重试
end
end
end
Client->>Logger : 记录最终结果统计
Client-->>Client : 返回完整结果
```

**图示来源**
- [github_client.py](file://utils/github_client.py#L1-L217)

**本节来源**
- [github_client.py](file://utils/github_client.py#L1-L217)

### 文件管理器分析

`file_manager.py` 模块负责所有文件操作和状态管理。

#### 类结构

```mermaid
classDiagram
class Checkpoint {
+str last_scan_time
+Set[str] scanned_shas
+Set[str] processed_queries
+to_dict() Dict[str, Any]
+from_dict(data Dict[str, Any]) Checkpoint
+add_scanned_sha(sha str) void
+add_processed_query(query str) void
+update_scan_time() void
}
class FileManager {
+str data_dir
+str checkpoint_file
+str scanned_shas_file
+List[str] _search_queries
+str _detail_log_filename
+str _keys_valid_filename
+str _rate_limited_filename
+str _rate_limited_detail_filename
+__init__(data_dir str) void
+check() bool
+load_checkpoint() Checkpoint
+load_scanned_shas() Set[str]
+load_search_queries(queries_file_path str) List[str]
+save_checkpoint(checkpoint Checkpoint) void
+save_scanned_shas(scanned_shas Set[str]) void
+save_valid_keys(repo_name str, file_path str, file_url str, valid_keys List[str]) void
+save_rate_limited_keys(repo_name str, file_path str, file_url str, rate_limited_keys List[str]) void
+append_scanned_sha(sha str) void
+update_dynamic_filenames() void
+get_search_queries() List[str]
+_create_default_queries_file(queries_file str) void
+_need_filename_update(basename str, prefix str, current_date str, current_hour str) bool
+_need_daily_filename_update(basename str, prefix str, current_date str) bool
}
FileManager --> Checkpoint
```

**图示来源**
- [file_manager.py](file://utils/file_manager.py#L1-L431)

#### 检查点管理流程

```mermaid
flowchart TD
Start([程序启动]) --> LoadCheckpoint["加载检查点文件"]
LoadCheckpoint --> |文件存在| ParseCheckpoint["解析JSON数据"]
LoadCheckpoint --> |文件不存在| CreateNew["创建新检查点"]
ParseCheckpoint --> LoadScannedSHAs["从单独文件加载已扫描SHA"]
CreateNew --> LoadScannedSHAs
LoadScannedSHAs --> ReturnCheckpoint["返回检查点对象"]
UpdateCheckpoint --> SaveScannedSHAs["保存已扫描SHA到文件"]
SaveScannedSHAs --> SaveOtherData["保存其他数据到checkpoint.json"]
SaveOtherData --> Complete["完成保存"]
style Start fill:#9f9,stroke:#333
style ReturnCheckpoint fill:#9f9,stroke:#333
style Complete fill:#9f9,stroke:#333
```

**图示来源**
- [file_manager.py](file://utils/file_manager.py#L1-L431)

**本节来源**
- [file_manager.py](file://utils/file_manager.py#L1-L431)

## 依赖分析

项目各组件之间的依赖关系清晰，形成了良好的分层架构。

```mermaid
graph TD
A[hajimi_king.py] --> B[config.py]
A --> C[Logger.py]
A --> D[github_client.py]
A --> E[file_manager.py]
D --> B
D --> C
E --> B
E --> C
F[dry_run.py] --> B
F --> E
G[start_openrouter_only.py] --> A
G --> B
```

**图示来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [Logger.py](file://common/Logger.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [dry_run.py](file://scripts/dry_run.py)
- [start_openrouter_only.py](file://start_openrouter_only.py)

**本节来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)

## 测试策略

项目提供了`scripts/dry_run.py`脚本用于验证功能变更。

### Dry Run 脚本分析

```mermaid
flowchart TD
Start([运行dry_run.py]) --> Setup["准备测试内容"]
Setup --> Extract["执行密钥提取"]
Extract --> CheckBaseURL["检查是否包含base_url"]
CheckBaseURL --> |不包含| Skip["跳过提取"]
CheckBaseURL --> |包含| ApplyPattern["应用正则模式"]
ApplyPattern --> CheckProximity["检查距离约束"]
CheckProximity --> |不满足| SkipKey["跳过密钥"]
CheckProximity --> |满足| CheckContext["检查上下文"]
CheckContext --> |不满足| SkipKey
CheckContext --> |满足| Collect["收集密钥"]
Collect --> Deduplicate["去重"]
Deduplicate --> Save["保存结果"]
Save --> Output["输出成功信息"]
style Start fill:#9f9,stroke:#333
style Collect fill:#9f9,stroke:#333
style Deduplicate fill:#9f9,stroke:#333
style Save fill:#9f9,stroke:#333
style Output fill:#9f9,stroke:#333
```

**图示来源**
- [dry_run.py](file://scripts/dry_run.py#L1-L103)

### 扩展新功能的测试方法

1. **添加新的密钥提取规则**:
   - 在`hajimi_king.py`中添加新的提取函数
   - 在`dry_run.py`中添加相应的测试用例
   - 运行`dry_run.py`验证提取逻辑正确性

2. **扩展搜索策略**:
   - 修改`github_client.py`中的搜索逻辑
   - 在`hajimi_king.py`中调整查询处理流程
   - 使用`dry_run.py`验证整体流程

3. **添加新的密钥类型支持**:
   - 在`config.py`中添加新的配置项
   - 在`hajimi_king.py`中实现新的提取函数
   - 更新`main()`函数以支持新的提取逻辑
   - 在`start_openrouter_only.py`中添加相应的启动模式

**本节来源**
- [dry_run.py](file://scripts/dry_run.py#L1-L103)
- [hajimi_king.py](file://app/hajimi_king.py#L1-L595)

## 贡献流程

### 代码风格要求

1. **Python风格**: 遵循PEP 8规范
2. **类型注解**: 所有函数和方法必须包含类型注解
3. **日志输出**: 使用统一的`logger`实例进行日志记录
4. **异常处理**: 合理捕获和处理异常，避免程序崩溃
5. **配置管理**: 新功能的配置应通过`config.py`管理，避免硬编码

### 提交规范

1. **提交信息格式**: `<类型>: <简要描述>`
   - 类型包括: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
2. **提交粒度**: 每次提交只包含一个逻辑变更
3. **代码审查**: 所有变更必须通过Pull Request进行审查

### Pull Request审查标准

1. **功能完整性**: 变更是否完整实现了预期功能
2. **代码质量**: 是否符合代码风格要求，是否有冗余代码
3. **测试覆盖**: 是否包含相应的测试用例
4. **文档更新**: 是否更新了相关文档
5. **向后兼容**: 是否破坏了现有功能
6. **配置一致性**: 新功能是否通过配置文件正确管理

**本节来源**
- [hajimi_king.py](file://app/hajimi_king.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)