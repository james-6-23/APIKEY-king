# 快速开始

<cite>
**本文档中引用的文件**   
- [first_deploy.sh](file://first_deploy.sh)
- [pyproject.toml](file://pyproject.toml)
- [README.md](file://README.md)
- [env.example](file://env.example)
- [app/hajimi_king.py](file://app/hajimi_king.py)
- [common/config.py](file://common/config.py)
- [common/Logger.py](file://common/Logger.py) - *日志模块重构，提升输出体验*
- [start_openrouter_only.py](file://start_openrouter_only.py) - *新增 OpenRouter 专用启动脚本*
- [OPENROUTER_USAGE.md](file://OPENROUTER_USAGE.md) - *OpenRouter 使用说明文档*
- [queries.openrouter.txt](file://queries.openrouter.txt) - *OpenRouter 专用查询文件*
- [queries.openrouter.optimized.txt](file://queries.openrouter.optimized.txt) - *优化版 OpenRouter 查询文件*
</cite>

## 更新摘要
**已做更改**   
- 在“运行程序”部分新增 OpenRouter 专用模式的运行说明
- 在“配置环境变量”部分补充 OpenRouter 相关配置项
- 在“查看输出与日志”部分更新输出文件说明以包含 OpenRouter 情况
- 新增“OpenRouter 专用模式”独立章节
- 更新“常见问题与解决方案”以涵盖 OpenRouter 相关问题

## 目录
1. [环境准备](#环境准备)
2. [首次部署](#首次部署)
3. [配置环境变量](#配置环境变量)
4. [运行程序](#运行程序)
5. [查看输出与日志](#查看输出与日志)
6. [OpenRouter 专用模式](#openrouter-专用模式)
7. [常见问题与解决方案](#常见问题与解决方案)

## 环境准备

在开始部署APIKEY-king之前，需要确保您的系统已准备好必要的环境。

### Python版本要求
本项目要求Python版本不低于3.11。您可以通过以下命令检查当前Python版本：

```bash
python --version
```

如果系统未安装Python或版本过低，请前往[Python官方网站](https://www.python.org/)下载并安装符合要求的版本。

### 安装依赖管理工具
项目推荐使用`uv`作为包管理器，它比传统的`pip`更快。如果尚未安装`uv`，请运行以下命令进行安装：

```bash
pip install uv
```

### 安装项目依赖
项目的依赖项定义在`pyproject.toml`文件中。使用`uv`安装所有依赖：

```bash
uv pip install -r pyproject.toml
```

该命令将自动安装以下核心依赖：
- `google-generativeai>=0.8.5`：用于验证API密钥。
- `python-dotenv>=1.1.1`：用于加载环境变量。
- `requests>=2.32.4`：用于HTTP请求。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L0-L10)

## 首次部署

完成环境准备后，即可进行项目的首次部署。`first_deploy.sh`脚本是专为简化此过程而设计的。

### 操作流程
1.  **克隆仓库**：将APIKEY-king仓库克隆到本地。
2.  **执行部署脚本**：在项目根目录下运行`first_deploy.sh`脚本。

```bash
./first_deploy.sh
```

### 脚本执行步骤详解
`first_deploy.sh`脚本将自动执行以下步骤：

1.  **检查源码目录**：验证项目根目录下是否存在`Dockerfile`、`app/hajimi_king.py`、`env.example`和`queries.example`等关键文件。
2.  **检查Docker环境**：确认`docker`和`docker-compose`已正确安装且Docker服务正在运行。
3.  **设置部署目录结构**：
    *   在当前目录创建`data`文件夹用于存储数据。
    *   将`env.example`复制为`.env`作为配置文件。
    *   将`queries.example`复制到`data/queries.txt`作为查询文件。
    *   复制`docker-compose.yml`到当前目录。
4.  **配置GitHub Token**：脚本会检查`.env`文件中的`GITHUB_TOKENS`。如果为空或为示例值，会提示用户输入真实的GitHub Personal Access Token。
5.  **清理现有容器**：停止并移除任何可能存在的旧容器，避免冲突。
6.  **构建Docker镜像**：在源码目录下构建名为`hajimi-king:0.0.1`的Docker镜像。
7.  **启动服务**：使用`docker-compose`在后台启动服务。

部署成功后，脚本会输出部署文件的位置和管理命令。

**Section sources**
- [first_deploy.sh](file://first_deploy.sh#L0-L275)

## 配置环境变量

环境变量是控制程序行为的关键。所有配置都通过`.env`文件进行管理。

### 关键环境变量及其作用
编辑`.env`文件，根据您的需求进行配置。

#### 🔴 必填配置
| 变量名 | 说明 |
| :--- | :--- |
| `GITHUB_TOKENS` | **GitHub API访问令牌**，用于调用GitHub Code Search API。必须具有`public_repo`权限。支持多个Token，用逗号分隔，以提高搜索配额。 |

#### 🟡 重要配置（建议了解）
| 变量名 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `PROXY` | 空 | **代理服务器地址**，用于访问GitHub或Gemini API，防止IP被封禁。支持多个代理（逗号分隔）和认证，格式如`http://user:pass@proxy:port`。 |
| `DATA_PATH` | `/app/data` | **数据存储目录路径**，程序将在此路径下创建`keys`和`logs`等子目录。 |
| `DATE_RANGE_DAYS` | `730` | **仓库年龄过滤天数**，只扫描在此天数内有更新的仓库，以提高效率。 |
| `QUERIES_FILE` | `queries.txt` | **搜索查询配置文件路径**，文件位于`DATA_PATH`目录下，每行一个GitHub搜索表达式。 |
| `MODELSCOPE_EXTRACT_ONLY` | `true` | **仅提取模式**，当为`true`时，仅提取ModelScope密钥（ms-key），不进行验证或回退到Gemini提取。 |

#### 🟢 可选配置（高级）
| 变量名 | 说明 |
| :--- | :--- |
| `TARGET_BASE_URLS` | ModelScope密钥提取的目标基础URL，用逗号分隔。只有包含这些URL的文件才会被提取ms-key。 |
| `MS_USE_LOOSE_PATTERN` | 是否使用宽松的正则模式匹配ms-key。 |
| `MS_PROXIMITY_CHARS` | 在宽松模式下，ms-key与`TARGET_BASE_URLS`之间的最大字符距离。 |
| `MS_REQUIRE_KEY_CONTEXT` | 是否要求ms-key附近包含`key`、`token`、`secret`等上下文词以降低误报。 |
| `OPENROUTER_BASE_URLS` | OpenRouter密钥提取的目标基础URL，用逗号分隔。只有包含这些URL的文件才会被提取OpenRouter密钥。 |
| `OPENROUTER_USE_LOOSE_PATTERN` | 是否使用宽松的正则模式匹配OpenRouter密钥。 |
| `OPENROUTER_PROXIMITY_CHARS` | 在宽松模式下，OpenRouter密钥与`OPENROUTER_BASE_URLS`之间的最大字符距离。 |
| `OPENROUTER_REQUIRE_KEY_CONTEXT` | 是否要求OpenRouter密钥附近包含`key`、`token`、`secret`等上下文词以降低误报。 |
| `OPENROUTER_EXTRACT_ONLY` | 是否启用OpenRouter仅提取模式，当为`true`时，仅提取OpenRouter密钥，不进行验证。 |

**Section sources**
- [env.example](file://env.example#L0-L48)
- [common/config.py](file://common/config.py#L0-L169)

## 运行程序

部署完成后，您可以直接运行主程序进行密钥搜索。

### 命令行示例
使用`python`命令直接运行`hajimi_king.py`脚本，并通过`--mode`参数指定运行模式。

```bash
# 兼容模式：优先尝试提取ModelScope密钥，未命中时回退到Gemini密钥提取与验证
python app/hajimi_king.py --mode compatible

# 仅ModelScope模式：只提取包含TARGET_BASE_URLS的ms-key，不进行验证，不回退
python app/hajimi_king.py --mode modelscope-only
```

### 参数说明
*   `--mode modelscope-only`：启用仅提取模式，速度快，但不验证密钥有效性。
*   `--mode compatible`：兼容模式，会尝试验证密钥，但速度相对较慢。

**Section sources**
- [app/hajimi_king.py](file://app/hajimi_king.py#L161-L197)
- [README.md](file://README.md#L0-L41)

## 查看输出与日志

程序运行后，结果和日志将被保存在指定的目录中。

### 输出文件位置
*   **有效密钥列表**：`data/keys/keys_valid_YYYYMMDD.txt`
*   **详细日志**：`data/logs/keys_valid_detailYYYYMMDD.log`

### 日志关键信息
程序的控制台输出和日志文件会包含以下关键信息：
*   **启动信息**：显示程序启动时间、配置的Token数量、查询数量等。
*   **处理进度**：显示当前处理的查询、已处理的文件数、找到的有效密钥数等。
*   **密钥发现**：当发现密钥时，会输出`🔑 Found X ModelScope key(s)`或`🔍 Found X suspected key(s), validating...`。
*   **密钥验证结果**：对于Gemini密钥，会输出`✅ VALID`、`⏱️ RATE LIMITED`或`❌ INVALID`。
*   **最终统计**：程序被中断时，会输出最终找到的有效密钥总数和被限流的密钥总数。

**更新** 日志样式已重构，采用彩色图标和更清晰的格式，提升可读性。

**Section sources**
- [README.md](file://README.md#L0-L41)
- [app/hajimi_king.py](file://app/hajimi_king.py#L400-L523)
- [common/Logger.py](file://common/Logger.py#L0-L182) - *日志模块重构*

## OpenRouter 专用模式

项目新增了对OpenRouter API密钥的专用提取支持，可通过专用脚本或参数快速启动。

### 启动方式
#### 方法一：使用专用启动脚本（推荐）
```bash
python start_openrouter_only.py
```

#### 方法二：使用命令行参数
```bash
python app/hajimi_king.py --mode openrouter-only
```

### 功能特点
- ✅ **高效过滤**：只在包含OpenRouter API地址的文件中搜索
- ✅ **智能识别**：精确匹配`sk-or-v1-[64位十六进制]`格式
- ✅ **占位符过滤**：自动过滤示例和占位符密钥
- ✅ **无验证模式**：纯提取，不进行API调用验证
- ✅ **增量扫描**：避免重复扫描已处理的文件

### 配置要求
确保`.env`文件中包含以下配置：
```bash
# 启用OpenRouter提取
OPENROUTER_BASE_URLS=https://openrouter.ai/api/v1,openrouter.ai
OPENROUTER_EXTRACT_ONLY=true

# 禁用其他服务以提高效率
TARGET_BASE_URLS=
MODELSCOPE_EXTRACT_ONLY=false

# 推荐使用专用查询文件
QUERIES_FILE=queries.openrouter.txt
```

**Section sources**
- [start_openrouter_only.py](file://start_openrouter_only.py#L0-L45) - *新增 OpenRouter 专用启动脚本*
- [OPENROUTER_USAGE.md](file://OPENROUTER_USAGE.md#L0-L109) - *OpenRouter 使用说明文档*
- [app/hajimi_king.py](file://app/hajimi_king.py#L300-L350) - *OpenRouter 密钥提取逻辑*
- [common/config.py](file://common/config.py#L130-L150) - *OpenRouter 配置项*

## 常见问题与解决方案

针对首次部署和运行时可能遇到的常见问题，提供即时解决方案。

### 权限错误
*   **问题**：运行`first_deploy.sh`时提示`Permission denied`。
*   **解决方案**：确保脚本具有可执行权限。运行`chmod +x first_deploy.sh`后再执行。

### 依赖缺失
*   **问题**：执行`uv pip install -r pyproject.toml`时失败，提示找不到`uv`。
*   **解决方案**：首先安装`uv`：`pip install uv`。

### 认证失败
*   **问题**：程序日志中出现`GitHub tokens not found`或`not_authorized_key`。
*   **解决方案**：
    1.  检查`.env`文件中的`GITHUB_TOKENS`是否已正确填写。
    2.  确认GitHub Token具有`public_repo`权限。
    3.  确保Token未过期。

### OpenRouter模式无输出
*   **问题**：运行OpenRouter专用模式未找到任何密钥。
*   **解决方案**：
    1.  检查`.env`文件中的`OPENROUTER_BASE_URLS`是否正确配置。
    2.  确认`QUERIES_FILE`指向`queries.openrouter.txt`。
    3.  检查GitHub Token是否有效且未被限流。

### 其他问题
*   **问题**：未搜索到任何密钥。
*   **解决方案**：检查`data/queries.txt`中的搜索表达式是否准确，建议在GitHub上手动测试查询。
*   **问题**：程序频繁被限流（Rate Limited）。
*   **解决方案**：配置多个`GITHUB_TOKENS`，并设置`PROXY`使用代理。

**Section sources**
- [common/config.py](file://common/config.py#L143-L167)
- [CHANGELOG.md](file://CHANGELOG.md#L36-L81)