# 快速开始

<cite>
**本文档中引用的文件**   
- [pyproject.toml](file://pyproject.toml)
- [README.md](file://README.md)
- [scripts/quick_launch.py](file://scripts/quick_launch.py) - *新增快捷启动脚本*
- [scripts/quick_scan.sh](file://scripts/quick_scan.sh) - *新增快捷扫描脚本*
- [src/main.py](file://src/main.py) - *核心启动文件已迁移至此*
- [config/default.yaml](file://config/default.yaml) - *主配置文件*
- [src/utils/logger.py](file://src/utils/logger.py) - *日志模块*
</cite>

## 更新摘要
**已做更改**   
- 更新“运行程序”部分，反映核心启动文件变更及新快捷脚本
- 修正“首次部署”部分中已废弃的脚本引用
- 调整“环境准备”中的依赖安装说明以匹配新项目结构
- 移除对已删除文件（如`app/hajimi_king.py`、`first_deploy.sh`）的引用
- 新增“快捷启动方式”独立章节
- 更新所有受影响的文件路径和命令示例

## 目录
1. [环境准备](#环境准备)
2. [首次部署](#首次部署)
3. [配置环境变量](#配置环境变量)
4. [运行程序](#运行程序)
5. [快捷启动方式](#快捷启动方式)
6. [查看输出与日志](#查看输出与日志)
7. [常见问题与解决方案](#常见问题与解决方案)

## 环境准备

在开始部署APIKEY-king之前，需要确保您的系统已准备好必要的环境。

### Python版本要求
本项目要求Python版本不低于3.11。您可以通过以下命令检查当前Python版本：

```bash
python --version
```

如果系统未安装Python或版本过低，请前往[Python官方网站](https://www.python.org/)下载并安装符合要求的版本。

### 安装依赖管理工具
项目推荐使用`uv`作为包管理器，它比传统的`pip`更快。如果尚未安装`uv`，请运行以下命令进行安装：

```bash
pip install uv
```

### 安装项目依赖
项目的依赖项定义在`pyproject.toml`文件中。使用`uv`安装所有依赖：

```bash
uv sync
```

该命令将自动安装`pyproject.toml`中定义的所有依赖项。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L0-L10)

## 首次部署

完成环境准备后，即可进行项目的首次部署。由于项目结构重构，旧版`first_deploy.sh`脚本已被移除。

### 操作流程
1.  **克隆仓库**：将APIKEY-king仓库克隆到本地。
2.  **初始化配置**：将`config/default.yaml`复制为`config/config.yaml`作为主配置文件。
3.  **创建数据目录**：在项目根目录下创建`data`文件夹，用于存储扫描结果和日志。

```bash
mkdir data
```

**Section sources**
- [config/default.yaml](file://config/default.yaml#L0-L50)

## 配置环境变量

环境变量是控制程序行为的关键。所有配置都通过`config/config.yaml`文件进行管理。

### 关键环境变量及其作用
编辑`config/config.yaml`文件，根据您的需求进行配置。

#### 🔴 必填配置
| 变量名 | 说明 |
| :--- | :--- |
| `GITHUB_TOKENS` | **GitHub API访问令牌**，用于调用GitHub Code Search API。必须具有`public_repo`权限。支持多个Token，用逗号分隔，以提高搜索配额。 |

#### 🟡 重要配置（建议了解）
| 变量名 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `PROXY` | 空 | **代理服务器地址**，用于访问GitHub或Gemini API，防止IP被封禁。支持多个代理（逗号分隔）和认证，格式如`http://user:pass@proxy:port`。 |
| `DATA_PATH` | `./data` | **数据存储目录路径**，程序将在此路径下创建`keys`和`logs`等子目录。 |
| `DATE_RANGE_DAYS` | `730` | **仓库年龄过滤天数**，只扫描在此天数内有更新的仓库，以提高效率。 |
| `QUERIES_FILE` | `gemini.txt` | **搜索查询配置文件路径**，文件位于`config/queries/`目录下，每行一个GitHub搜索表达式。 |
| `MODELSCOPE_EXTRACT_ONLY` | `true` | **仅提取模式**，当为`true`时，仅提取ModelScope密钥（ms-key），不进行验证或回退到Gemini提取。 |

#### 🟢 可选配置（高级）
| 变量名 | 说明 |
| :--- | :--- |
| `TARGET_BASE_URLS` | ModelScope密钥提取的目标基础URL，用逗号分隔。只有包含这些URL的文件才会被提取ms-key。 |
| `MS_USE_LOOSE_PATTERN` | 是否使用宽松的正则模式匹配ms-key。 |
| `MS_PROXIMITY_CHARS` | 在宽松模式下，ms-key与`TARGET_BASE_URLS`之间的最大字符距离。 |
| `MS_REQUIRE_KEY_CONTEXT` | 是否要求ms-key附近包含`key`、`token`、`secret`等上下文词以降低误报。 |
| `OPENROUTER_BASE_URLS` | OpenRouter密钥提取的目标基础URL，用逗号分隔。只有包含这些URL的文件才会被提取OpenRouter密钥。 |
| `OPENROUTER_USE_LOOSE_PATTERN` | 是否使用宽松的正则模式匹配OpenRouter密钥。 |
| `OPENROUTER_PROXIMITY_CHARS` | 在宽松模式下，OpenRouter密钥与`OPENROUTER_BASE_URLS`之间的最大字符距离。 |
| `OPENROUTER_REQUIRE_KEY_CONTEXT` | 是否要求OpenRouter密钥附近包含`key`、`token`、`secret`等上下文词以降低误报。 |
| `OPENROUTER_EXTRACT_ONLY` | 是否启用OpenRouter仅提取模式，当为`true`时，仅提取OpenRouter密钥，不进行验证。 |

**Section sources**
- [config/default.yaml](file://config/default.yaml#L0-L50)
- [src/models/config.py](file://src/models/config.py#L0-L120)

## 运行程序

部署完成后，您可以直接运行主程序进行密钥搜索。

### 命令行示例
使用`python`命令运行新的主入口文件`src/main.py`。

```bash
# 兼容模式：优先尝试提取ModelScope密钥，未命中时回退到Gemini密钥提取与验证
python src/main.py --mode compatible

# 仅ModelScope模式：只提取包含TARGET_BASE_URLS的ms-key，不进行验证，不回退
python src/main.py --mode modelscope-only
```

### 参数说明
*   `--mode modelscope-only`：启用仅提取模式，速度快，但不验证密钥有效性。
*   `--mode compatible`：兼容模式，会尝试验证密钥，但速度相对较慢。

**Section sources**
- [src/main.py](file://src/main.py#L100-L180)
- [README.md](file://README.md#L0-L40)

## 快捷启动方式

为简化操作，项目提供了快捷启动脚本。

### 使用快捷脚本
#### 扫描模式（Linux/macOS）
```bash
bash scripts/quick_scan.sh
```

#### 扫描模式（Windows）
```cmd
scripts\quick_scan.bat
```

#### 自定义快速启动
您可以使用`scripts/quick_launch.py`脚本进行自定义配置启动：

```bash
python scripts/quick_launch.py --mode openrouter-only --config config/config.yaml
```

**Section sources**
- [scripts/quick_scan.sh](file://scripts/quick_scan.sh#L0-L30)
- [scripts/quick_scan.bat](file://scripts/quick_scan.bat#L0-L20)
- [scripts/quick_launch.py](file://scripts/quick_launch.py#L0-L60)

## 查看输出与日志

程序运行后，结果和日志将被保存在指定的目录中。

### 输出文件位置
*   **有效密钥列表**：`data/keys/keys_valid_YYYYMMDD.txt`
*   **详细日志**：`data/logs/keys_valid_detailYYYYMMDD.log`

### 日志关键信息
程序的控制台输出和日志文件会包含以下关键信息：
*   **启动信息**：显示程序启动时间、配置的Token数量、查询数量等。
*   **处理进度**：显示当前处理的查询、已处理的文件数、找到的有效密钥数等。
*   **密钥发现**：当发现密钥时，会输出`🔑 Found X ModelScope key(s)`或`🔍 Found X suspected key(s), validating...`。
*   **密钥验证结果**：对于Gemini密钥，会输出`✅ VALID`、`⏱️ RATE LIMITED`或`❌ INVALID`。
*   **最终统计**：程序被中断时，会输出最终找到的有效密钥总数和被限流的密钥总数。

**更新** 日志样式已重构，采用彩色图标和更清晰的格式，提升可读性。

**Section sources**
- [README.md](file://README.md#L0-L40)
- [src/main.py](file://src/main.py#L300-L450)
- [src/utils/logger.py](file://src/utils/logger.py#L0-L150)

## 常见问题与解决方案

针对首次部署和运行时可能遇到的常见问题，提供即时解决方案。

### 权限错误
*   **问题**：运行`quick_scan.sh`时提示`Permission denied`。
*   **解决方案**：确保脚本具有可执行权限。运行`chmod +x scripts/quick_scan.sh`后再执行。

### 依赖缺失
*   **问题**：执行`uv sync`时失败，提示找不到`uv`。
*   **解决方案**：首先安装`uv`：`pip install uv`。

### 认证失败
*   **问题**：程序日志中出现`GitHub tokens not found`或`not_authorized_key`。
*   **解决方案**：
    1.  检查`config/config.yaml`文件中的`GITHUB_TOKENS`是否已正确填写。
    2.  确认GitHub Token具有`public_repo`权限。
    3.  确保Token未过期。

### 无输出或扫描无结果
*   **问题**：运行程序未找到任何密钥。
*   **解决方案**：
    1.  检查`config/queries/`目录下的查询文件（如`gemini.txt`）内容是否准确。
    2.  建议在GitHub上手动测试查询表达式。
    3.  确认`GITHUB_TOKENS`有效且未被限流。

### 程序频繁被限流
*   **问题**：程序频繁出现`RATE LIMITED`。
*   **解决方案**：配置多个`GITHUB_TOKENS`，并设置`PROXY`使用代理。

**Section sources**
- [src/models/config.py](file://src/models/config.py#L100-L140)
- [src/services/github_service.py](file://src/services/github_service.py#L50-L80)