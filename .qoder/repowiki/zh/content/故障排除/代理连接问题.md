# ä»£ç†è¿æ¥é—®é¢˜

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [config.py](file://common\config.py) - *å·²æ›´æ–°*
- [github_client.py](file://utils\github_client.py) - *å·²æ›´æ–°*
- [Logger.py](file://common\Logger.py) - *å·²é‡æ„ï¼Œæ–°å¢networkæ–¹æ³•*
- [hajimi_king.py](file://app\hajimi_king.py) - *ä½¿ç”¨Logger.networkæ–¹æ³•*
</cite>

## ç›®å½•
1. [é¡¹ç›®ç»“æ„åˆ†æ](#é¡¹ç›®ç»“æ„åˆ†æ)  
2. [æ ¸å¿ƒé…ç½®è§£æ](#æ ¸å¿ƒé…ç½®è§£æ)  
3. [ä»£ç†æœºåˆ¶å®ç°åŸç†](#ä»£ç†æœºåˆ¶å®ç°åŸç†)  
4. [æ—¥å¿—ç³»ç»Ÿä¸é”™è¯¯è¯†åˆ«](#æ—¥å¿—ç³»ç»Ÿä¸é”™è¯¯è¯†åˆ«)  
5. [ä»£ç†é—®é¢˜æ’æŸ¥æµç¨‹](#ä»£ç†é—®é¢˜æ’æŸ¥æµç¨‹)  
6. [ç‹¬ç«‹éªŒè¯ä¸é›†æˆæµ‹è¯•](#ç‹¬ç«‹éªŒè¯ä¸é›†æˆæµ‹è¯•)

## é¡¹ç›®ç»“æ„åˆ†æ

æœ¬é¡¹ç›®ä¸ºä¸€ä¸ªè‡ªåŠ¨åŒ–å¯†é’¥æ‰«æä¸åŒæ­¥å·¥å…·ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ä»GitHubæœç´¢æ•æ„Ÿå¯†é’¥ï¼ˆå¦‚ModelScope APIå¯†é’¥ï¼‰ã€é€šè¿‡ä»£ç†è®¿é—®å—é™èµ„æºã€å¹¶æ”¯æŒè´Ÿè½½å‡è¡¡æœåŠ¡åŒæ­¥ã€‚é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå„ç›®å½•èŒè´£æ¸…æ™°ã€‚

```mermaid
graph TD
A[app] --> A1[hajimi_king.py]
B[common] --> B1[config.py]
B --> B2[Logger.py]
C[scripts] --> C1[dry_run.py]
D[utils] --> D1[github_client.py]
D --> D2[file_manager.py]
D --> D3[sync_utils.py]
A1 --> B1
A1 --> D1
D1 --> B1
D1 --> B2
C1 --> B1
C1 --> D2
```

**å›¾ç¤ºæ¥æº**  
- [config.py](file://common\config.py)
- [github_client.py](file://utils\github_client.py)
- [dry_run.py](file://scripts\dry_run.py)

**æœ¬èŠ‚æ¥æº**  
- [config.py](file://common\config.py)
- [github_client.py](file://utils\github_client.py)
- [dry_run.py](file://scripts\dry_run.py)

## æ ¸å¿ƒé…ç½®è§£æ

`config.py` æ˜¯æ•´ä¸ªé¡¹ç›®çš„é…ç½®ä¸­å¿ƒï¼Œè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡å¹¶æä¾›ç»Ÿä¸€è®¿é—®æ¥å£ã€‚å…¶ä¸­ä¸ä»£ç†ç›¸å…³çš„é…ç½®é¡¹å¦‚ä¸‹ï¼š

- **PROXY_LIST_STR**: ç¯å¢ƒå˜é‡ `PROXY` çš„åŸå§‹å­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šç§æ ¼å¼ä»£ç†åœ°å€ï¼Œå¦‚ `http://user:pass@host:port`ã€`socks5://host:port`ã€‚
- **PROXY_LIST**: å°† `PROXY_LIST_STR` æŒ‰é€—å·åˆ†å‰²åç”Ÿæˆçš„ä»£ç†åˆ—è¡¨ã€‚
- **get_random_proxy()**: éšæœºè¿”å›ä¸€ä¸ªä»£ç†é…ç½®ï¼Œä¾› `requests` åº“ä½¿ç”¨ã€‚

```python
@classmethod
def get_random_proxy(cls) -> Optional[Dict[str, str]]:
    if not cls.PROXY_LIST:
        return None
    proxy_url = random.choice(cls.PROXY_LIST).strip()
    return {
        'http': proxy_url,
        'https': proxy_url
    }
```

è¯¥æ–¹æ³•è¿”å›ç¬¦åˆ `requests` åº“è¦æ±‚çš„ `proxies` å­—å…¸ç»“æ„ï¼Œè‡ªåŠ¨åŒæ—¶åº”ç”¨äº HTTP å’Œ HTTPS è¯·æ±‚ã€‚

**æœ¬èŠ‚æ¥æº**  
- [config.py](file://common\config.py)

## ä»£ç†æœºåˆ¶å®ç°åŸç†

`github_client.py` ä¸­çš„ `GitHubClient` ç±»è´Ÿè´£è°ƒç”¨ GitHub API è¿›è¡Œä»£ç æœç´¢å’Œæ–‡ä»¶å†…å®¹è·å–ã€‚å…¶ä»£ç†åº”ç”¨é€»è¾‘å¦‚ä¸‹ï¼š

### è¯·æ±‚æµç¨‹ä¸­çš„ä»£ç†æ³¨å…¥

åœ¨æ¯æ¬¡å‘èµ· `GET` è¯·æ±‚å‰ï¼Œä¼šè°ƒç”¨ `Config.get_random_proxy()` è·å–ä»£ç†é…ç½®ï¼Œå¹¶å°†å…¶ä¼ å…¥ `requests.get()` æ–¹æ³•ï¼š

```python
proxies = Config.get_random_proxy()
if proxies:
    response = requests.get(self.GITHUB_API_URL, headers=headers, params=params, timeout=30, proxies=proxies)
else:
    response = requests.get(self.GITHUB_API_URL, headers=headers, params=params, timeout=30)
```

æ­¤æœºåˆ¶ç¡®ä¿ï¼š
- è‹¥æœªé…ç½®ä»£ç†ï¼Œåˆ™ç›´æ¥ç›´è¿ã€‚
- è‹¥é…ç½®äº†å¤šä¸ªä»£ç†ï¼Œåˆ™æ¯æ¬¡è¯·æ±‚éšæœºé€‰æ‹©ä¸€ä¸ªï¼Œå®ç°ç®€å•çš„è´Ÿè½½å‡è¡¡ã€‚

### ä»£ç†æ ¼å¼æ”¯æŒ

æ”¯æŒæ ‡å‡†çš„ URL æ ¼å¼ä»£ç†ï¼š
- `http://proxy.example.com:8080`
- `http://user:password@proxy.example.com:8080`
- `socks5://proxy.example.com:1080`

> âš ï¸ æ³¨æ„ï¼šè‹¥ä»£ç†åœ°å€æ ¼å¼é”™è¯¯ï¼ˆå¦‚ç¼ºå°‘åè®®å¤´ã€ç«¯å£éæ³•ï¼‰ï¼Œå°†å¯¼è‡´ `requests` æŠ›å‡ºå¼‚å¸¸ã€‚

```mermaid
sequenceDiagram
participant Client as GitHubClient
participant Config as Config
participant Requests as requestsåº“
participant Proxy as ä»£ç†æœåŠ¡å™¨
participant GitHub as GitHub API
Client->>Config : get_random_proxy()
Config-->>Client : è¿”å›ä»£ç†å­—å…¸
Client->>Requests : å‘èµ·GETè¯·æ±‚å«proxies
alt ä»£ç†é…ç½®å­˜åœ¨
Requests->>Proxy : é€šè¿‡ä»£ç†è½¬å‘è¯·æ±‚
Proxy->>GitHub : è½¬å‘è¯·æ±‚
GitHub-->>Proxy : è¿”å›å“åº”
Proxy-->>Requests : è¿”å›å“åº”
else æ— ä»£ç†é…ç½®
Requests->>GitHub : ç›´è¿è¯·æ±‚
GitHub-->>Requests : è¿”å›å“åº”
end
Requests-->>Client : è¿”å›å“åº”å¯¹è±¡
```

**å›¾ç¤ºæ¥æº**  
- [github_client.py](file://utils\github_client.py)
- [config.py](file://common\config.py)

**æœ¬èŠ‚æ¥æº**  
- [github_client.py](file://utils\github_client.py)
- [config.py](file://common\config.py)

## æ—¥å¿—ç³»ç»Ÿä¸é”™è¯¯è¯†åˆ«

`Logger.py` æä¾›äº†ç»“æ„åŒ–çš„æ—¥å¿—è¾“å‡ºåŠŸèƒ½ï¼Œä¾¿äºè¯†åˆ«ä»£ç†ç›¸å…³é”™è¯¯ã€‚æœ€è¿‘çš„é‡æ„å¢å¼ºäº†æ—¥å¿—åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ç½‘ç»œæ“ä½œçš„è®°å½•ã€‚

### æ—¥å¿—çº§åˆ«è¯´æ˜

| æ—¥å¿—çº§åˆ« | è¾“å‡ºæ ¼å¼ | ç”¨é€” |
|--------|--------|------|
| info | ç™½è‰²æ–‡æœ¬ | æ­£å¸¸æµç¨‹ã€ç»Ÿè®¡ä¿¡æ¯ |
| warning | é»„è‰²æ–‡æœ¬ | å¯æ¢å¤è­¦å‘Šï¼ˆå¦‚é€Ÿç‡é™åˆ¶æ¥è¿‘ï¼‰ |
| error | çº¢è‰²æ–‡æœ¬ + åˆ†éš”çº¿ | ä¸¥é‡é”™è¯¯ï¼ˆå¦‚è¿æ¥å¤±è´¥ã€è®¤è¯å¤±è´¥ï¼‰ |

### æ–°å¢ç½‘ç»œæ—¥å¿—æ–¹æ³•

åœ¨æœ€è¿‘çš„é‡æ„ä¸­ï¼Œ`Logger` ç±»æ–°å¢äº† `network()` æ–¹æ³•ï¼Œä¸“é—¨ç”¨äºè®°å½•ç½‘ç»œç›¸å…³æ“ä½œï¼Œä½¿ç”¨ ğŸŒ å›¾æ ‡è¿›è¡Œæ ‡è¯†ã€‚

```python
def network(self, message: str, *args, **kwargs):
    """ç½‘ç»œç›¸å…³æ—¥å¿—"""
    self._logger.info(f"ğŸŒ {message}", *args, **kwargs)
```

è¯¥æ–¹æ³•åœ¨ä»¥ä¸‹åœºæ™¯ä¸­è¢«è°ƒç”¨ï¼š

**åœ¨ `github_client.py` ä¸­ï¼š**
```python
logger.network(f"Processing file: {metadata_url}")
logger.network(f"Checking for keys from: {download_url}, status: {content_response.status_code}")
```

**åœ¨ `hajimi_king.py` ä¸­ï¼š**
```python
logger.network(f"Proxy: {len(Config.PROXY_LIST)} proxies configured")
```

### å…³é”®é”™è¯¯æ—¥å¿—è¯†åˆ«

#### 1. ä»£ç†è¿æ¥è¶…æ—¶
```log
âŒ Network error after 5 attempts on page 1: Timeout
```
- **å«ä¹‰**ï¼šè¿ç»­5æ¬¡å°è¯•å‡è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ä»£ç†ä¸å¯è¾¾æˆ–ç½‘ç»œé˜»å¡ã€‚
- **å¯èƒ½åŸå› **ï¼šä»£ç†åœ°å€é”™è¯¯ã€é˜²ç«å¢™æ‹¦æˆªã€ä»£ç†æœåŠ¡å™¨å®•æœºã€‚

#### 2. SSLæ¡æ‰‹å¤±è´¥
```log
âŒ Network error after 5 attempts on page 1: SSLError
```
- **å«ä¹‰**ï¼šSSL/TLS æ¡æ‰‹å¤±è´¥ã€‚
- **å¯èƒ½åŸå› **ï¼šä»£ç†æœåŠ¡å™¨è¯ä¹¦ä¸å—ä¿¡ä»»ã€ä¸­é—´äººæ”»å‡»ã€`requests` åº“æœªæ­£ç¡®å¤„ç†ä»£ç†çš„SSLã€‚

#### 3. ä»£ç†è®¤è¯å¤±è´¥
```log
âŒ HTTP 407 error after 5 attempts on page 1
```
- **å«ä¹‰**ï¼šHTTP 407 Proxy Authentication Requiredã€‚
- **å¯èƒ½åŸå› **ï¼šä»£ç†ç”¨æˆ·å/å¯†ç é”™è¯¯ã€è®¤è¯æ–¹å¼ä¸æ”¯æŒï¼ˆå¦‚NTLMï¼‰ã€‚

#### 4. é€Ÿç‡é™åˆ¶è­¦å‘Š
```log
âš ï¸ Rate limit low: 2 remaining, token: xxxxx
```
- **å«ä¹‰**ï¼šå½“å‰Tokenå‰©ä½™è¯·æ±‚æ¬¡æ•°ä½äº3æ¬¡ã€‚
- **æ³¨æ„**ï¼šæ­¤ä¸ºGitHubé€Ÿç‡é™åˆ¶ï¼Œéä»£ç†é™åˆ¶ã€‚

**æœ¬èŠ‚æ¥æº**  
- [Logger.py](file://common\Logger.py) - *æ–°å¢networkæ–¹æ³•*
- [github_client.py](file://utils\github_client.py) - *ä½¿ç”¨networkæ–¹æ³•è®°å½•ç½‘ç»œæ“ä½œ*
- [hajimi_king.py](file://app\hajimi_king.py) - *ä½¿ç”¨networkæ–¹æ³•è®°å½•ä»£ç†é…ç½®*

## ä»£ç†é—®é¢˜æ’æŸ¥æµç¨‹

å½“å‡ºç°ä»£ç†è¿æ¥é—®é¢˜æ—¶ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é€æ­¥æ’æŸ¥ï¼š

### ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä»£ç†å¯è¾¾æ€§

ä½¿ç”¨ `curl` å‘½ä»¤è¡Œå·¥å…·ç‹¬ç«‹æµ‹è¯•ä»£ç†æ˜¯å¦å¯ç”¨ï¼š

```bash
# æµ‹è¯•HTTPä»£ç†
curl -x http://user:pass@proxy.example.com:8080 -I https://api.github.com

# æµ‹è¯•SOCKS5ä»£ç†
curl --socks5-hostname user:pass@proxy.example.com:1080 -I https://api.github.com
```

- âœ… æˆåŠŸï¼šè¿”å› `HTTP/2 200` æˆ– `HTTP/1.1 200 OK`
- âŒ å¤±è´¥ï¼šæ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ `Connection timed out`ã€`407 Proxy Authentication Required`ï¼‰

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥é˜²ç«å¢™ä¸ç½‘ç»œç­–ç•¥

- ç¡®è®¤æœ¬åœ°é˜²ç«å¢™æœªé˜»æ­¢å‡ºç«™è¿æ¥ã€‚
- ç¡®è®¤ä»£ç†æœåŠ¡å™¨ç«¯å£ï¼ˆå¦‚8080ã€1080ï¼‰åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾ã€‚
- è‹¥åœ¨ä¼ä¸šç½‘ç»œä¸­ï¼Œç¡®è®¤ITç­–ç•¥å…è®¸ä½¿ç”¨å¤–éƒ¨ä»£ç†ã€‚

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•åŸºç¡€ç½‘ç»œè¿é€šæ€§

```bash
# æµ‹è¯•DNSè§£æ
nslookup proxy.example.com

# æµ‹è¯•ç«¯å£è¿é€šæ€§
telnet proxy.example.com 8080
# æˆ–ä½¿ç”¨ PowerShell
Test-NetConnection proxy.example.com -Port 8080
```

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥ä»£ç†æ ¼å¼ä¸é…ç½®

ç¡®è®¤ `.env` æ–‡ä»¶ä¸­ `PROXY` å˜é‡æ ¼å¼æ­£ç¡®ï¼š

```env
# æ­£ç¡®ç¤ºä¾‹
PROXY=http://user:pass@192.168.1.100:8080,socks5://192.168.1.101:1080

# é”™è¯¯ç¤ºä¾‹ï¼ˆç¼ºå°‘åè®®ï¼‰
PROXY=192.168.1.100:8080
```

### ç¬¬äº”æ­¥ï¼šå¯ç”¨è°ƒè¯•æ—¥å¿—

åœ¨ `github_client.py` ä¸­ä¸´æ—¶æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œç¡®è®¤ `proxies` å‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼š

```python
print(f"Debug: Using proxies = {proxies}")
```

**æœ¬èŠ‚æ¥æº**  
- [config.py](file://common\config.py)
- [github_client.py](file://utils\github_client.py)

## ç‹¬ç«‹éªŒè¯ä¸é›†æˆæµ‹è¯•

### ä½¿ç”¨ `dry_run.py` è¿›è¡Œé›†æˆæµ‹è¯•

`scripts/dry_run.py` æä¾›äº†ä¸€ä¸ªè½»é‡çº§çš„é›†æˆæµ‹è¯•è„šæœ¬ï¼Œå¯ç”¨äºéªŒè¯å¯†é’¥æå–é€»è¾‘å’Œä»£ç†é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚

#### æ‰§è¡Œæ­¥éª¤ï¼š

1. ç¡®ä¿ `.env` æ–‡ä»¶ä¸­å·²æ­£ç¡®é…ç½® `PROXY`ã€‚
2. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
   ```bash
   python scripts/dry_run.py
   ```
3. è§‚å¯Ÿè¾“å‡ºï¼š
   - è‹¥æˆåŠŸï¼šæ˜¾ç¤º `[dry-run] æå–æˆåŠŸå¹¶å·²å†™å…¥`
   - è‹¥å¤±è´¥ï¼šç»“åˆæ—¥å¿—åˆ¤æ–­æ˜¯ä»£ç†é—®é¢˜è¿˜æ˜¯é€»è¾‘é—®é¢˜ã€‚

#### æµ‹è¯•ç›®çš„ï¼š
- éªŒè¯ä»£ç†é…ç½®èƒ½å¦æˆåŠŸåŠ è½½ã€‚
- éªŒè¯ `requests` æ˜¯å¦èƒ½é€šè¿‡ä»£ç†è·å–å¤–éƒ¨èµ„æºï¼ˆæ¨¡æ‹ŸGitHub APIè°ƒç”¨ï¼‰ã€‚
- éªŒè¯å¯†é’¥æå–é€»è¾‘æ˜¯å¦æ­£å¸¸ã€‚

**æœ¬èŠ‚æ¥æº**  
- [dry_run.py](file://scripts\dry_run.py)
- [config.py](file://common\config.py)