# 故障排除

<cite>
**本文档引用的文件**   
- [Logger.py](file://common/Logger.py)
- [config.py](file://common/config.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [hajimi_king.py](file://app/hajimi_king.py)
- [dry_run.py](file://scripts/dry_run.py)
</cite>

## 更新摘要
**已做更改**   
- 全面更新“日志格式解析”章节，反映 `Logger.py` 的重构变更
- 新增“日志级别与图标”子章节，介绍新的日志类型和视觉标识
- 更新“调试技巧”章节，增加启用 `DEBUG` 级别日志的方法
- 更新“错误代码对照表”，增加新的日志标识如 `RATE LIMITED` 和 `VALID`
- 所有内容已按要求完全转换为中文

## 目录
1. [简介](#简介)
2. [日志格式解析](#日志格式解析)
   - [日志级别与图标](#日志级别与图标)
   - [错误日志特殊格式](#错误日志特殊格式)
   - [文件日志归档](#文件日志归档)
3. [高频问题分类与解决](#高频问题分类与解决)
   - [GitHub API 速率限制 (403/429)](#github-api-速率限制-403429)
   - [令牌失效](#令牌失效)
   - [代理连接失败](#代理连接失败)
   - [密钥验证失败](#密钥验证失败)
4. [调试技巧](#调试技巧)
5. [性能问题处理](#性能问题处理)
6. [错误代码对照表](#错误代码对照表)

## 简介
本文档旨在为用户提供一份详尽的故障排除指南，帮助用户快速诊断和解决在使用 `APIKEY-king` 项目时可能遇到的常见问题。通过分析 `Logger.py` 生成的日志格式，用户可以学习如何解读关键日志条目，从而定位错误源头。文档将高频问题进行了分类整理，包括 GitHub API 速率限制、令牌失效、代理连接失败和密钥验证失败等，并为每个问题提供了详细的错误现象描述、可能原因分析和分步解决步骤。此外，文档还包含了调试技巧和性能问题处理建议，以帮助用户优化系统性能。**注意：自 `383c253` 提交起，同步功能已被完全移除，相关配置和日志输出不再存在。**

**Section sources**
- [hajimi_king.py](file://app/hajimi_king.py) - *同步功能已移除*
- [config.py](file://common/config.py) - *同步配置已移除*

## 日志格式解析
`Logger.py` 文件经过重构，显著提升了日志的可读性和功能性。新的日志模块引入了彩色输出和图标标识，使不同级别的日志信息更加直观。日志格式已更新为 `%(asctime)s | %(levelname)s | %(message)s` 用于文件日志，而控制台日志则采用更丰富的格式，包含时间、图标和颜色。

### 日志级别与图标
重构后的 `Logger` 类支持多种日志级别，并为每个级别分配了独特的图标和颜色：
- `DEBUG` (`🔍` 青色): 用于输出详细的调试信息。
- `INFO` (`ℹ️` 绿色): 用于输出一般性的信息性消息。
- `WARNING` (`⚠️` 黄色): 用于输出警告信息，表示潜在问题。
- `ERROR` (`❌` 红色): 用于输出错误信息，通常会显示在分隔线之间。
- `CRITICAL` (`🚨` 紫色): 用于输出严重错误信息。
- `SUCCESS` (`✅` 绿色): 一个自定义方法，用于标记成功操作。
- `PROGRESS` (`📈` 绿色): 一个自定义方法，用于显示进度条。
- `NETWORK` (`🌐` 绿色): 一个自定义方法，用于记录网络操作。
- `FILE_OP` (`📁` 绿色): 一个自定义方法，用于记录文件操作。
- `SECURITY` (`🔒` 黄色): 一个自定义方法，用于记录安全相关事件。
- `RATE_LIMIT` (`⏱️` 黄色): 一个自定义方法，专门用于记录速率限制事件。

**Section sources**
- [Logger.py](file://common/Logger.py#L1-L182)

### 错误日志特殊格式
当记录 `ERROR` 级别的日志时，系统会采用特殊的格式化方式。错误消息会被包裹在由 `┌`, `─`, `│`, `└` 字符构成的边框内，使其在日志流中更加醒目，便于用户快速识别和定位问题。

**Section sources**
- [Logger.py](file://common/Logger.py#L1-L182)

### 文件日志归档
日志模块现在支持将日志按天归档。日志文件会存储在 `data/logs` 目录下，文件名格式为 `app_YYYYMMDD.log`。这有助于长期运行的服务管理和日志分析。

**Section sources**
- [Logger.py](file://common/Logger.py#L1-L182)

## 高频问题分类与解决

### GitHub API 速率限制 (403/429)
#### 错误现象
- 日志中出现 `❌ Rate limit hit, status:403 (attempt X/Y) - waiting Zs` 或 `❌ Rate limit hit, status:429 (attempt X/Y) - waiting Zs`。
- 日志中出现 `⚠️ Rate limit low: N remaining, token: XXX`。
- 搜索结果数量异常少或完全失败。

#### 可能原因
- 使用的 GitHub Token 请求频率超过了 GitHub API 的速率限制。
- 单个 Token 的请求频率过高，导致被临时封禁。
- 未配置代理，导致 IP 地址被 GitHub 识别为异常流量。

#### 解决步骤
1. **检查日志**：确认日志中是否出现 `Rate limit hit` 或 `Rate limit low` 的警告。
2. **增加 Token**：在 `.env` 文件中增加更多的 GitHub Token，以分散请求压力。
3. **配置代理**：在 `.env` 文件中配置 `PROXY` 变量，使用代理服务器来轮换 IP 地址，避免单个 IP 被封禁。
4. **调整请求频率**：在 `github_client.py` 中，可以调整 `search_for_keys` 方法的 `max_retries` 参数，减少重试次数，降低请求频率。
5. **等待恢复**：如果已经被限流，等待一段时间（通常为几分钟到几小时）后重试。

**Section sources**
- [github_client.py](file://utils/github_client.py#L1-L218)
- [config.py](file://common/config.py#L1-L170)

### 令牌失效
#### 错误现象
- 日志中出现 `❌ HTTP 401 error after 5 attempts on page X`。
- 搜索结果完全失败，无法获取任何数据。

#### 可能原因
- 使用的 GitHub Token 已过期或被撤销。
- Token 权限不足，未包含 `public_repo` 权限。

#### 解决步骤
1. **检查日志**：确认日志中是否出现 `HTTP 401 error`。
2. **验证 Token**：登录 GitHub，检查 `.env` 文件中配置的 Token 是否仍然有效。
3. **重新生成 Token**：如果 Token 已过期或被撤销，重新生成一个新的 Token，并确保其包含 `public_repo` 权限。
4. **更新配置**：将新的 Token 更新到 `.env` 文件中，并重启服务。

**Section sources**
- [github_client.py](file://utils/github_client.py#L1-L218)
- [config.py](file://common/config.py#L1-L170)

### 代理连接失败
#### 错误现象
- 日志中出现 `❌ Network error after 5 attempts on page X: ConnectionError`。
- 日志中出现 `❌ Network error after 5 attempts on page X: Timeout`。

#### 可能原因
- 配置的代理服务器地址错误或不可达。
- 代理服务器需要认证，但未提供正确的用户名和密码。
- 代理服务器本身存在问题，无法正常工作。

#### 解决步骤
1. **检查日志**：确认日志中是否出现 `Network error` 或 `ConnectionError`。
2. **验证代理配置**：检查 `.env` 文件中的 `PROXY` 变量，确保代理服务器地址正确无误。
3. **测试代理连通性**：使用 `curl` 或其他工具测试代理服务器的连通性，确保代理服务器可以正常访问。
4. **检查认证信息**：如果代理服务器需要认证，确保在 `PROXY` 变量中提供了正确的用户名和密码。
5. **更换代理**：如果当前代理服务器存在问题，尝试更换为其他可用的代理服务器。

**Section sources**
- [github_client.py](file://utils/github_client.py#L1-L218)
- [config.py](file://common/config.py#L1-L170)

### 密钥验证失败
#### 错误现象
- 日志中出现 `❌ INVALID: XXX, check result: not_authorized_key`。
- 日志中出现 `❌ INVALID: XXX, check result: disabled`。
- 日志中出现 `❌ INVALID: XXX, check result: error:XXX`。

#### 可能原因
- 提取的密钥本身无效或已被撤销。
- 密钥对应的 API 服务未启用或被禁用。
- 密钥验证过程中出现网络错误或其他异常。

#### 解决步骤
1. **检查日志**：确认日志中是否出现 `INVALID` 的密钥及其验证结果。
2. **手动验证**：使用提取的密钥手动调用相应的 API 服务，验证其有效性。
3. **检查服务状态**：确认密钥对应的 API 服务是否已启用且正常运行。
4. **忽略无效密钥**：对于已确认无效的密钥，可以忽略它们，继续处理其他密钥。

**Section sources**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L511)
- [config.py](file://common/config.py#L1-L170)

## 调试技巧
1. **启用详细日志**：在 `Logger.py` 中，将 `logging.basicConfig` 的 `level` 参数设置为 `DEBUG`，以启用详细日志输出。
2. **使用 dry_run.py 进行测试验证**：运行 `scripts/dry_run.py` 脚本，模拟密钥提取过程，验证提取逻辑是否正确。
3. **检查网络连通性**：使用 `ping` 或 `curl` 命令检查与 GitHub API 和 Gemini API 的网络连通性。
4. **查看配置文件**：检查 `.env` 文件中的配置是否正确，特别是 `GITHUB_TOKENS` 和 `PROXY` 的配置。

**Section sources**
- [Logger.py](file://common/Logger.py#L1-L182)
- [dry_run.py](file://scripts/dry_run.py#L1-L104)
- [config.py](file://common/config.py#L1-L170)

## 性能问题处理
#### 扫描速度缓慢
##### 可能原因
- 查询表达式过于宽泛，导致搜索结果数量过多。
- 未配置代理，导致请求频率受限。
- 网络延迟较高，影响请求响应速度。

##### 优化策略
1. **优化查询表达式**：使用更精确的查询表达式，减少不必要的搜索结果。
2. **配置代理**：使用代理服务器来轮换 IP 地址，提高请求成功率。
3. **增加 Token**：增加更多的 GitHub Token，以分散请求压力。
4. **调整请求频率**：在 `github_client.py` 中，适当调整 `search_for_keys` 方法的 `max_retries` 参数，平衡请求频率和成功率。

**Section sources**
- [github_client.py](file://utils/github_client.py#L1-L218)
- [config.py](file://common/config.py#L1-L170)

## 错误代码对照表
| 日志标识 | 问题类型 | 说明 |
|--------|--------|------|
| `Rate limit hit` | GitHub API 速率限制 | 请求频率超过限制，需等待恢复或增加 Token |
| `HTTP 401 error` | 令牌失效 | GitHub Token 无效或权限不足 |
| `Network error` | 代理连接失败 | 代理服务器不可达或配置错误 |
| `INVALID` | 密钥验证失败 | 提取的密钥无效或服务被禁用 |
| `RATE LIMITED` | Gemini API 速率限制 | 验证密钥时触发了Gemini API的速率限制 |
| `VALID` | 密钥验证成功 | 提取的密钥通过了验证，是有效的 |

**Section sources**
- [github_client.py](file://utils/github_client.py#L1-L218)
- [hajimi_king.py](file://app/hajimi_king.py#L1-L511)