# å¢é‡æ‰«ææœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**  
- [app/hajimi_king.py](file://app/hajimi_king.py)
- [utils/file_manager.py](file://utils/file_manager.py)
- [common/config.py](file://common/config.py)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)  
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)  
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)  
4. [å¢é‡æ‰«ææœºåˆ¶è¯¦è§£](#å¢é‡æ‰«ææœºåˆ¶è¯¦è§£)  
5. [ä¸»å¾ªç¯ä¸æ–‡ä»¶å¤„ç†é€»è¾‘](#ä¸»å¾ªç¯ä¸æ–‡ä»¶å¤„ç†é€»è¾‘)  
6. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)  
7. [ç»“è®º](#ç»“è®º)

## å¼•è¨€
æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡è‡ªåŠ¨åŒ–æ–¹å¼ä»GitHubä¸Šæ‰«æå¹¶æå–æ½œåœ¨çš„APIå¯†é’¥ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹Geminiå’ŒModelScopeå¹³å°çš„å¯†é’¥ã€‚ä¸ºæå‡æ‰«ææ•ˆç‡å¹¶é¿å…é‡å¤å¤„ç†ï¼Œç³»ç»Ÿå¼•å…¥äº†**å¢é‡æ‰«ææœºåˆ¶**ï¼Œåˆ©ç”¨æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰è®°å½•ä¸Šæ¬¡æ‰«æçŠ¶æ€ï¼Œä»…å¤„ç†æ–°å¢æˆ–æ›´æ–°çš„å†…å®¹ã€‚è¯¥æœºåˆ¶æ˜¾è‘—å‡å°‘äº†ç½‘ç»œè¯·æ±‚å’Œè®¡ç®—èµ„æºçš„æµªè´¹ï¼Œæé«˜äº†æ•´ä½“è¿è¡Œæ•ˆç‡ã€‚

## é¡¹ç›®ç»“æ„
é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

```mermaid
graph TD
A[app/hajimi_king.py] --> B[utils/file_manager.py]
A --> C[utils/github_client.py]
A --> D[common/Logger.py]
A --> E[common/config.py]
B --> E
C --> E
C --> D
F[utils/sync_utils.py] --> B
G[scripts/dry_run.py] --> A
```

**å›¾ç¤ºæ¥æº**  
- [app/hajimi_king.py](file://app/hajimi_king.py)
- [utils/file_manager.py](file://utils/file_manager.py)
- [utils/github_client.py](file://utils/github_client.py)

## æ ¸å¿ƒç»„ä»¶
ç³»ç»Ÿç”±å¤šä¸ªæ ¸å¿ƒæ¨¡å—æ„æˆï¼ŒååŒå®Œæˆæ‰«æä»»åŠ¡ï¼š

- **hajimi_king.py**ï¼šä¸»ç¨‹åºå…¥å£ï¼Œæ§åˆ¶æ‰«ææµç¨‹ã€‚
- **file_manager.py**ï¼šè´Ÿè´£æ–‡ä»¶ç®¡ç†ã€æ£€æŸ¥ç‚¹æŒä¹…åŒ–åŠæœç´¢æŸ¥è¯¢åŠ è½½ã€‚
- **github_client.py**ï¼šå°è£…GitHub APIè°ƒç”¨ï¼Œå®ç°æœç´¢ä¸æ–‡ä»¶å†…å®¹è·å–ã€‚
- **config.py**ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹ï¼Œæ”¯æŒç¯å¢ƒå˜é‡æ³¨å…¥ã€‚
- **Logger.py**ï¼šæä¾›ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡ºæ¥å£ã€‚

## å¢é‡æ‰«ææœºåˆ¶è¯¦è§£
å¢é‡æ‰«æçš„æ ¸å¿ƒåœ¨äº**æ£€æŸ¥ç‚¹æœºåˆ¶**ï¼Œé€šè¿‡è®°å½•ä¸Šæ¬¡æ‰«æçš„æ—¶é—´æˆ³å’Œå·²å¤„ç†æ–‡ä»¶çš„SHAå€¼ï¼Œå®ç°å¯¹æ–°å¢æˆ–å˜æ›´å†…å®¹çš„ç²¾å‡†è¯†åˆ«ã€‚

### æ£€æŸ¥ç‚¹æ•°æ®ç»“æ„
`Checkpoint` ç±»å®šä¹‰äº†æ‰«æçŠ¶æ€çš„æŒä¹…åŒ–ç»“æ„ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®å­—æ®µï¼š

- `last_scan_time`ï¼šä¸Šä¸€æ¬¡æ‰«æå®Œæˆçš„æ—¶é—´ï¼ˆISOæ ¼å¼å­—ç¬¦ä¸²ï¼‰ã€‚
- `scanned_shas`ï¼šå·²æ‰«ææ–‡ä»¶çš„SHAé›†åˆï¼Œç”¨äºå»é‡ã€‚
- `processed_queries`ï¼šå·²æ‰§è¡Œçš„æœç´¢æŸ¥è¯¢è¯­å¥é›†åˆã€‚
- `wait_send_balancer` / `wait_send_gpt_load`ï¼šå¾…åŒæ­¥çš„å¯†é’¥é˜Ÿåˆ—ã€‚

```python
@dataclass
class Checkpoint:
    last_scan_time: Optional[str] = None
    scanned_shas: Set[str] = field(default_factory=set)
    processed_queries: Set[str] = field(default_factory=set)
    wait_send_balancer: Set[str] = field(default_factory=set)
    wait_send_gpt_load: Set[str] = field(default_factory=set)
```

**æ¥æº**  
- [utils/file_manager.py](file://utils/file_manager.py#L12-L48)

### æ—¶é—´æˆ³æ¯”å¯¹é€»è¾‘
åœ¨æ¯æ¬¡å¤„ç†æœç´¢ç»“æœé¡¹æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ `should_skip_item` å‡½æ•°åˆ¤æ–­æ˜¯å¦è·³è¿‡ï¼š

1. è‹¥ `checkpoint.last_scan_time` å­˜åœ¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º `datetime` å¯¹è±¡ã€‚
2. è·å–å½“å‰ä»“åº“çš„ `pushed_at` æ—¶é—´ï¼ˆå³æœ€åä¸€æ¬¡æ¨é€æ—¶é—´ï¼‰ã€‚
3. è‹¥ `pushed_at <= last_scan_time`ï¼Œè¯´æ˜è¯¥ä»“åº“åœ¨ä¸Šæ¬¡æ‰«æåæœªæ›´æ–°ï¼Œç›´æ¥è·³è¿‡ã€‚

```python
if checkpoint.last_scan_time:
    last_scan_dt = datetime.fromisoformat(checkpoint.last_scan_time)
    repo_pushed_at = item["repository"].get("pushed_at")
    if repo_pushed_at:
        repo_pushed_dt = datetime.strptime(repo_pushed_at, "%Y-%m-%dT%H:%M:%SZ")
        if repo_pushed_dt <= last_scan_dt:
            return True, "time_filter"
```

æ­¤é€»è¾‘ç¡®ä¿äº†åªæœ‰åœ¨ä¸Šæ¬¡æ‰«æä¹‹åå‘ç”Ÿè¿‡æ›´æ–°çš„ä»“åº“æ‰ä¼šè¢«å¤„ç†ï¼Œä»è€Œé¿å…äº†å¯¹é™æ€å†…å®¹çš„é‡å¤æ‰«æã€‚

### SHAå€¼å»é‡æœºåˆ¶
æ¯ä¸ªæœç´¢ç»“æœé¡¹åŒ…å«ä¸€ä¸ª `sha` å­—æ®µï¼Œä»£è¡¨è¯¥æ–‡ä»¶åœ¨Gitä¸­çš„å”¯ä¸€å“ˆå¸Œå€¼ã€‚ç³»ç»Ÿé€šè¿‡ç»´æŠ¤ `scanned_shas` é›†åˆï¼Œç¡®ä¿åŒä¸€æ–‡ä»¶ä¸ä¼šè¢«é‡å¤å¤„ç†ï¼š

```python
if item.get("sha") in checkpoint.scanned_shas:
    return True, "sha_duplicate"
```

ä¸€æ—¦å¤„ç†å®Œä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶SHAå€¼ä¼šè¢«æ·»åŠ åˆ°æ£€æŸ¥ç‚¹ä¸­ï¼Œå¹¶åœ¨ä¸‹æ¬¡æ‰«ææ—¶æŒä¹…åŒ–ä¿å­˜ã€‚

**æ¥æº**  
- [app/hajimi_king.py](file://app/hajimi_king.py#L170-L180)
- [utils/file_manager.py](file://utils/file_manager.py#L45-L48)

## ä¸»å¾ªç¯ä¸æ–‡ä»¶å¤„ç†é€»è¾‘
`hajimi_king.py` ä¸­çš„ `main()` å‡½æ•°æ˜¯æ•´ä¸ªæ‰«æä»»åŠ¡çš„æ§åˆ¶ä¸­å¿ƒï¼Œå…¶ä¸»å¾ªç¯é€»è¾‘å¦‚ä¸‹ï¼š

### å¯åŠ¨é˜¶æ®µ
1. åˆå§‹åŒ– `FileManager` å®ä¾‹å¹¶åŠ è½½æ£€æŸ¥ç‚¹ã€‚
2. è¾“å‡ºç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¯å¦è¿›å…¥â€œå¢é‡æ‰«ææ¨¡å¼â€æˆ–â€œå…¨é‡æ‰«ææ¨¡å¼â€ã€‚
3. è‹¥å­˜åœ¨ `last_scan_time`ï¼Œåˆ™è¿›å…¥å¢é‡æ¨¡å¼ã€‚

```python
checkpoint = file_manager.load_checkpoint()
if checkpoint.last_scan_time:
    logger.info(f"ğŸ’¾ Checkpoint found - Incremental scan mode")
else:
    logger.info(f"ğŸ’¾ No checkpoint - Full scan mode")
```

### æ‰«æå¾ªç¯
ä¸»å¾ªç¯æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

1. éå†æ‰€æœ‰æœç´¢æŸ¥è¯¢ã€‚
2. å¯¹æ¯ä¸ªæŸ¥è¯¢ç»“æœä¸­çš„ `item` è°ƒç”¨ `should_skip_item(item, checkpoint)` åˆ¤æ–­æ˜¯å¦è·³è¿‡ã€‚
3. è‹¥æœªè·³è¿‡ï¼Œåˆ™è°ƒç”¨ `process_item(item)` å¤„ç†æ–‡ä»¶å†…å®¹ã€‚
4. å¤„ç†å®Œæˆåï¼Œå°†è¯¥æ–‡ä»¶çš„ `sha` æ·»åŠ è‡³ `checkpoint.scanned_shas`ã€‚
5. å®šæœŸæ›´æ–°æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼Œé˜²æ­¢ç¨‹åºä¸­æ–­å¯¼è‡´çŠ¶æ€ä¸¢å¤±ã€‚

```python
for item_index, item in enumerate(items, 1):
    should_skip, skip_reason = should_skip_item(item, checkpoint)
    if should_skip:
        continue
    valid_count, rate_limited_count = process_item(item)
    checkpoint.add_scanned_sha(item.get("sha"))
```

å…¶ä¸­ï¼Œ`is_new_content()` åŠŸèƒ½ç”± `should_skip_item()` å®ç°ï¼Œå®ƒç»¼åˆäº†æ—¶é—´æˆ³å’ŒSHAå€¼åŒé‡åˆ¤æ–­ï¼Œç¡®ä¿ä»…å¤„ç†çœŸæ­£çš„æ–°å†…å®¹ã€‚

**æ¥æº**  
- [app/hajimi_king.py](file://app/hajimi_king.py#L300-L400)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®
ä¸ºæœ€å¤§åŒ–å¢é‡æ‰«æçš„æ•ˆç‡ï¼Œå»ºè®®ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–ï¼š

### åˆç†è®¾ç½®æ—¶é—´çª—å£
é€šè¿‡ `Config.DATE_RANGE_DAYS` é…ç½®é¡¹ï¼ˆé»˜è®¤730å¤©ï¼‰ï¼Œç³»ç»Ÿå¯è¿‡æ»¤æ‰è¿‡äºé™ˆæ—§çš„ä»“åº“ã€‚é€‚å½“ç¼©çŸ­è¯¥å€¼ï¼ˆå¦‚30æˆ–90å¤©ï¼‰å¯å¤§å¹…å‡å°‘æœç´¢ç»“æœæ•°é‡ï¼Œæå‡æ‰«æé€Ÿåº¦ï¼Œä½†å¯èƒ½é—æ¼å†å²é¡¹ç›®ä¸­çš„å¯†é’¥ã€‚éœ€æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡è¦†ç›–ç‡ä¸æ‰§è¡Œæ•ˆç‡ã€‚

### ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
åœ¨ `queries.txt` ä¸­ä½¿ç”¨æ›´ç²¾ç¡®çš„æœç´¢è¯­æ³•ï¼ˆå¦‚é™å®šæ–‡ä»¶ç±»å‹ã€è·¯å¾„ç­‰ï¼‰ï¼Œå¯å‡å°‘æ— æ•ˆç»“æœã€‚ä¾‹å¦‚ï¼š
```
AIzaSy in:file filename:.env path:/config/
```

### æ§åˆ¶æ‰«æé¢‘ç‡
å½“å‰ä¸»å¾ªç¯æœ«å°¾æœ‰10ç§’ä¼‘çœ ï¼ˆ`time.sleep(10)`ï¼‰ï¼Œå¯æ ¹æ®GitHub APIé…é¢å’Œç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ï¼Œé¿å…è§¦å‘é€Ÿç‡é™åˆ¶ã€‚

### åˆ†å¸ƒå¼ä¸å¹¶è¡ŒåŒ–
å¯¹äºå¤§è§„æ¨¡æ‰«æä»»åŠ¡ï¼Œå¯è€ƒè™‘å°†ä¸åŒæŸ¥è¯¢åˆ†é…è‡³å¤šä¸ªå®ä¾‹å¹¶è¡Œæ‰§è¡Œï¼Œå…±äº«åŒä¸€æ£€æŸ¥ç‚¹å­˜å‚¨ï¼ˆå¦‚Redisï¼‰ï¼Œè¿›ä¸€æ­¥æå‡ååé‡ã€‚

## ç»“è®º
æœ¬ç³»ç»Ÿçš„å¢é‡æ‰«ææœºåˆ¶é€šè¿‡**æ—¶é—´æˆ³æ¯”å¯¹**å’Œ**SHAå€¼å»é‡**åŒé‡ç­–ç•¥ï¼Œæœ‰æ•ˆè¯†åˆ«å¹¶å¤„ç†æ–°å¢æˆ–æ›´æ–°çš„ä»£ç å†…å®¹ï¼Œæ˜¾è‘—é™ä½äº†é‡å¤æ‰«æå¸¦æ¥çš„èµ„æºå¼€é”€ã€‚ç»“åˆ `file_manager.py` çš„æ£€æŸ¥ç‚¹æŒä¹…åŒ–å’Œ `hajimi_king.py` çš„ä¸»å¾ªç¯æ§åˆ¶ï¼Œå®ç°äº†é«˜æ•ˆã€ç¨³å®šçš„å¯†é’¥æ‰«æèƒ½åŠ›ã€‚æœªæ¥å¯é€šè¿‡å¼•å…¥æ›´æ™ºèƒ½çš„å˜æ›´æ£€æµ‹ç®—æ³•ï¼ˆå¦‚åŸºäºæ–‡ä»¶å†…å®¹å“ˆå¸Œï¼‰è¿›ä¸€æ­¥æå‡ç²¾åº¦ã€‚