# æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**  
- [hajimi_king.py](file://app/hajimi_king.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [config.py](file://common/config.py)
- [Logger.py](file://common/Logger.py) - *åœ¨æäº¤ edd314dab04a8b79c67ce8761837a874cbbf0b3c ä¸­æ›´æ–°*
- [start_openrouter_only.py](file://start_openrouter_only.py) - *æ–°å¢äºæäº¤ 21a2b1b3f753f0bb5854ba70d35dd21ab11b16e9*
- [OPENROUTER_USAGE.md](file://OPENROUTER_USAGE.md) - *æ–°å¢äºæäº¤ 21a2b1b3f753f0bb5854ba70d35dd21ab11b16e9*
- [queries.openrouter.txt](file://queries.openrouter.txt) - *æ–°å¢äºæäº¤ 21a2b1b3f753f0bb5854ba70d35dd21ab11b16e9*
- [queries.openrouter.optimized.txt](file://queries.openrouter.optimized.txt) - *æ–°å¢äºæäº¤ 21a2b1b3f753f0bb5854ba70d35dd21ab11b16e9*
</cite>

## æ›´æ–°æ‘˜è¦
**å·²åšæ›´æ”¹**   
- æ–°å¢â€œOpenRouterå¯†é’¥æå–æœºåˆ¶â€ç« èŠ‚ï¼Œè¯¦ç»†è¯´æ˜OpenRouterå¯†é’¥çš„æå–é€»è¾‘ä¸é…ç½®
- åœ¨â€œå¯†é’¥æå–æœºåˆ¶â€ç« èŠ‚ä¸­è¡¥å……OpenRouterå¯†é’¥çš„æ­£åˆ™è¡¨è¾¾å¼ä¸ä¸Šä¸‹æ–‡éªŒè¯é€»è¾‘
- æ›´æ–°â€œæ ¸å¿ƒç»„ä»¶è§£æâ€ç« èŠ‚ï¼Œè¯´æ˜`hajimi_king.py`ä¸­æ–°å¢çš„`extract_openrouter_keys`å‡½æ•°
- åœ¨â€œæ‰«æç®¡ç†ä¸å¢é‡æ‰«æâ€ç« èŠ‚ä¸­è¯´æ˜`--mode openrouter-only`å‘½ä»¤è¡Œå‚æ•°çš„å®ç°æœºåˆ¶
- æ·»åŠ â€œOpenRouterä¸“ç”¨æ‰«ææ¨¡å¼â€ç« èŠ‚ï¼Œä»‹ç»ä¸“ç”¨å¯åŠ¨è„šæœ¬å’Œä½¿ç”¨æŒ‡å—
- æ›´æ–°æ–‡æ¡£æ¥æºä»¥åæ˜ æ–°å¢çš„æ–‡ä»¶å’ŒåŠŸèƒ½
- ä¿æŒå…¶ä»–æ‰€æœ‰éƒ¨åˆ†ä¸å˜ï¼Œå› ä¸ºç›¸å…³æäº¤ä¸»è¦æ¶‰åŠOpenRouteråŠŸèƒ½çš„æ·»åŠ 

## ç›®å½•
1. [é¡¹ç›®ç»“æ„åˆ†æ](#é¡¹ç›®ç»“æ„åˆ†æ)
2. [æ ¸å¿ƒç»„ä»¶è§£æ](#æ ¸å¿ƒç»„ä»¶è§£æ)
3. [å¯†é’¥æœç´¢æµç¨‹](#å¯†é’¥æœç´¢æµç¨‹)
4. [å¯†é’¥æå–æœºåˆ¶](#å¯†é’¥æå–æœºåˆ¶)
5. [æ‰«æç®¡ç†ä¸å¢é‡æ‰«æ](#æ‰«æç®¡ç†ä¸å¢é‡æ‰«æ)
6. [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
7. [é”™è¯¯å¤„ç†ä¸æ€§èƒ½ä¼˜åŒ–](#é”™è¯¯å¤„ç†ä¸æ€§èƒ½ä¼˜åŒ–)
8. [OpenRouterå¯†é’¥æå–æœºåˆ¶](#openrouterå¯†é’¥æå–æœºåˆ¶)
9. [OpenRouterä¸“ç”¨æ‰«ææ¨¡å¼](#openrouterä¸“ç”¨æ‰«ææ¨¡å¼)

## é¡¹ç›®ç»“æ„åˆ†æ

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–åˆ†å±‚æ¶æ„ï¼Œä¸»è¦åˆ†ä¸ºå››ä¸ªåŠŸèƒ½ç›®å½•ï¼š

- **app**: ä¸»ç¨‹åºå…¥å£ `hajimi_king.py`
- **utils**: å·¥å…·æ¨¡å—ï¼ŒåŒ…å« `github_client.py`ã€`file_manager.py` å’Œ `sync_utils.py`
- **common**: å…¬å…±ç»„ä»¶ï¼ŒåŒ…å« `config.py` å’Œ `Logger.py`
- **scripts**: è„šæœ¬æ–‡ä»¶ï¼Œå¦‚ `dry_run.py`

```mermaid
graph TD
A[ä¸»ç¨‹åº hajimi_king.py] --> B[GitHubå®¢æˆ·ç«¯ github_client.py]
A --> C[æ–‡ä»¶ç®¡ç†å™¨ file_manager.py]
A --> D[é…ç½®ç®¡ç† config.py]
A --> E[æ—¥å¿—ç»„ä»¶ Logger.py]
C --> D
B --> D
B --> E
C --> E
```

**å›¾ç¤ºæ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)
- [config.py](file://common/config.py)
- [Logger.py](file://common/Logger.py)

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py)
- [github_client.py](file://utils/github_client.py)
- [file_manager.py](file://utils/file_manager.py)

## æ ¸å¿ƒç»„ä»¶è§£æ

### ä¸»æ§åˆ¶å™¨ï¼šhajimi_king.py

`hajimi_king.py` æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ§åˆ¶æ¨¡å—ï¼Œè´Ÿè´£åè°ƒå„ä¸ªç»„ä»¶å®Œæˆå¯†é’¥æ‰«æä»»åŠ¡ã€‚

```mermaid
classDiagram
class hajimi_king {
+github_utils : GitHubClient
+file_manager : FileManager
+checkpoint : Checkpoint
+main()
+process_item()
+validate_gemini_key()
+extract_ms_keys_for_modelscope()
+should_skip_item()
+extract_openrouter_keys()
}
```

**å›¾ç¤ºæ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L524)

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L1-L524)

### GitHubå®¢æˆ·ç«¯ï¼šgithub_client.py

`GitHubClient` ç±»å°è£…äº†ä¸GitHub APIçš„äº¤äº’é€»è¾‘ï¼Œæ”¯æŒå¤šä»¤ç‰Œè½®æ¢å’Œä»£ç†é…ç½®ã€‚

```mermaid
classDiagram
class GitHubClient {
-tokens : List[str]
-_token_ptr : int
+GITHUB_API_URL : str
+__init__(tokens)
+_next_token() : str
+search_for_keys(query) : Dict
+get_file_content(item) : str
+create_instance(tokens) : GitHubClient
}
```

**å›¾ç¤ºæ¥æº**
- [github_client.py](file://utils/github_client.py#L11-L216)

**æœ¬èŠ‚æ¥æº**
- [github_client.py](file://utils/github_client.py#L11-L216)

### æ–‡ä»¶ç®¡ç†å™¨ï¼šfile_manager.py

`FileManager` å’Œ `Checkpoint` ç±»è´Ÿè´£ç®¡ç†æ‰«æçŠ¶æ€å’Œæ–‡ä»¶æ“ä½œã€‚

```mermaid
classDiagram
class Checkpoint {
-last_scan_time : str
-scanned_shas : Set[str]
-processed_queries : Set[str]
+to_dict() : Dict
+from_dict(data) : Checkpoint
+add_scanned_sha(sha)
+add_processed_query(query)
+update_scan_time()
}
class FileManager {
-data_dir : str
-checkpoint_file : str
-scanned_shas_file : str
+__init__(data_dir)
+check() : bool
+load_checkpoint() : Checkpoint
+save_checkpoint(checkpoint)
+save_valid_keys(repo, path, url, keys)
+save_rate_limited_keys(repo, path, url, keys)
+update_dynamic_filenames()
}
FileManager --> Checkpoint
```

**å›¾ç¤ºæ¥æº**
- [file_manager.py](file://utils/file_manager.py#L12-L48)
- [file_manager.py](file://utils/file_manager.py#L50-L492)

**æœ¬èŠ‚æ¥æº**
- [file_manager.py](file://utils/file_manager.py#L12-L492)

## å¯†é’¥æœç´¢æµç¨‹

å¯†é’¥æœç´¢æµç¨‹ç”± `hajimi_king.py` ä¸­çš„ `main()` å‡½æ•°é©±åŠ¨ï¼Œé€šè¿‡ `GitHubClient` å‘èµ·æœç´¢è¯·æ±‚ã€‚

```mermaid
sequenceDiagram
participant ä¸»ç¨‹åº as hajimi_king.py
participant GitHubå®¢æˆ·ç«¯ as GitHubClient
participant GitHubAPI as GitHub API
ä¸»ç¨‹åº->>ä¸»ç¨‹åº : è¯»å–æŸ¥è¯¢æ–‡ä»¶
loop æ¯ä¸ªæŸ¥è¯¢
ä¸»ç¨‹åº->>GitHubå®¢æˆ·ç«¯ : search_for_keys(query)
GitHubå®¢æˆ·ç«¯->>GitHubAPI : GET /search/code
GitHubAPI-->>GitHubå®¢æˆ·ç«¯ : è¿”å›æœç´¢ç»“æœ
GitHubå®¢æˆ·ç«¯-->>ä¸»ç¨‹åº : è¿”å›itemsåˆ—è¡¨
loop æ¯ä¸ªitem
ä¸»ç¨‹åº->>ä¸»ç¨‹åº : should_skip_itemæ£€æŸ¥
alt ä¸è·³è¿‡
ä¸»ç¨‹åº->>ä¸»ç¨‹åº : process_itemå¤„ç†
end
end
end
```

**å›¾ç¤ºæ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L343-L524)
- [github_client.py](file://utils/github_client.py#L50-L150)

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L343-L524)
- [github_client.py](file://utils/github_client.py#L50-L150)

## å¯†é’¥æå–æœºåˆ¶

### ModelScopeå¯†é’¥æå–

ç³»ç»Ÿé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æå–ç¬¦åˆç‰¹å®šæ¨¡å¼çš„ModelScopeå¯†é’¥ï¼Œå¹¶ç»“åˆä¸Šä¸‹æ–‡éªŒè¯å‡å°‘è¯¯æŠ¥ã€‚

```python
def extract_ms_keys_for_modelscope(content: str) -> List[str]:
    # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡base_url
    has_base, base_positions = _contains_base_url(content, Config.TARGET_BASE_URLS)
    if not has_base:
        return []

    # å®šä¹‰æ­£åˆ™æ¨¡å¼
    strict_pat = r'(?i)\bms-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\b'
    loose_pat = r'(?i)\bms-[0-9a-f-]{30,}\b'
    pattern = loose_pat if Config.parse_bool(Config.MS_USE_LOOSE_PATTERN) else strict_pat

    # ä¸Šä¸‹æ–‡éªŒè¯
    ctx_re = re.compile(r"(key|token|secret|authorization|api[-_ ]?key)", re.IGNORECASE)
    
    results = []
    for m in re.finditer(pattern, content):
        k = m.group(0)
        if k.lower() == "ms-00000000-0000-0000-0000-000000000000":
            continue
            
        # è·ç¦»éªŒè¯
        if Config.MS_PROXIMITY_CHARS > 0 and base_positions:
            pos = m.start()
            near = any(abs(pos - bp) <= Config.MS_PROXIMITY_CHARS for bp in base_positions)
            if not near:
                continue
                
        # ä¸Šä¸‹æ–‡è¯éªŒè¯
        if Config.parse_bool(Config.MS_REQUIRE_KEY_CONTEXT):
            start = max(0, m.start() - 80)
            end = min(len(content), m.end() + 80)
            snippet = content[start:end]
            if not ctx_re.search(snippet):
                continue
                
        results.append(k)
        
    return list(dict.fromkeys(results))  # å»é‡ä¿åº
```

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L108-L158)

### Geminiå¯†é’¥æå–

é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ `r'(AIzaSy[A-Za-z0-9\-_]{33})'` æå–Geminiå¯†é’¥ï¼Œå¹¶è¿›è¡Œæœ‰æ•ˆæ€§éªŒè¯ã€‚

```python
def extract_keys_from_content(content: str) -> List[str]:
    pattern = r'(AIzaSy[A-Za-z0-9\-_]{33})'
    return re.findall(pattern, content)
```

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L103-L106)

## æ‰«æç®¡ç†ä¸å¢é‡æ‰«æ

### è·³è¿‡ç­–ç•¥

ç³»ç»Ÿé€šè¿‡ `should_skip_item()` å‡½æ•°å®ç°å¤šç§è·³è¿‡ç­–ç•¥ï¼š

```python
def should_skip_item(item: Dict[str, Any], checkpoint: Checkpoint) -> tuple[bool, str]:
    # æ—¶é—´è¿‡æ»¤ï¼šè·³è¿‡å·²æ‰«ææ—¶é—´ä¹‹å‰çš„ä»“åº“
    if checkpoint.last_scan_time:
        last_scan_dt = datetime.fromisoformat(checkpoint.last_scan_time)
        repo_pushed_at = item["repository"].get("pushed_at")
        if repo_pushed_at:
            repo_pushed_dt = datetime.strptime(repo_pushed_at, "%Y-%m-%dT%H:%M:%SZ")
            if repo_pushed_dt <= last_scan_dt:
                return True, "time_filter"

    # SHAé‡å¤è¿‡æ»¤
    if item.get("sha") in checkpoint.scanned_shas:
        return True, "sha_duplicate"

    # ä»“åº“å¹´é¾„è¿‡æ»¤
    repo_pushed_at = item["repository"].get("pushed_at")
    if repo_pushed_at:
        repo_pushed_dt = datetime.strptime(repo_pushed_at, "%Y-%m-%dT%H:%M:%SZ")
        if repo_pushed_dt < datetime.utcnow() - timedelta(days=Config.DATE_RANGE_DAYS):
            return True, "age_filter"

    # æ–‡ä»¶è·¯å¾„é»‘åå•è¿‡æ»¤
    lowercase_path = item["path"].lower()
    if any(token in lowercase_path for token in Config.FILE_PATH_BLACKLIST):
        return True, "doc_filter"

    return False, ""
```

### å¤šä»¤ç‰Œè½®æ¢ç­–ç•¥

`GitHubClient` å®ç°äº†å¤šä»¤ç‰Œè½®æ¢æœºåˆ¶ï¼Œé¿å…å•ä¸ªä»¤ç‰Œçš„é€Ÿç‡é™åˆ¶ï¼š

```python
def _next_token(self) -> Optional[str]:
    if not self.tokens:
        return None
    token = self.tokens[self._token_ptr % len(self.tokens)]
    self._token_ptr += 1
    return token.strip() if isinstance(token, str) else token
```

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L171-L210)
- [github_client.py](file://utils/github_client.py#L20-L30)

## æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### æ•°æ®æµè·¯å¾„

ä»æŸ¥è¯¢æ‰§è¡Œåˆ°ç»“æœå­˜å‚¨çš„å®Œæ•´æ•°æ®æµï¼š

```mermaid
flowchart TD
A[è¯»å–queries.txt] --> B[å‘èµ·GitHubæœç´¢]
B --> C[è·å–æœç´¢ç»“æœitems]
C --> D{éå†æ¯ä¸ªitem}
D --> E[should_skip_itemæ£€æŸ¥]
E --> |è·³è¿‡| F[è®°å½•è·³è¿‡ç»Ÿè®¡]
E --> |å¤„ç†| G[process_item]
G --> H[get_file_content]
H --> I[æå–å¯†é’¥]
I --> J[éªŒè¯å¯†é’¥]
J --> K[ä¿å­˜ç»“æœ]
K --> L[æ›´æ–°checkpoint]
D --> M[æ‰€æœ‰itemå¤„ç†å®Œæ¯•]
M --> N[ä¿å­˜checkpoint]
N --> O[è¿›å…¥ä¸‹ä¸€å¾ªç¯]
```

**å›¾ç¤ºæ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L343-L524)

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L343-L524)

### CheckpointçŠ¶æ€å˜è¿

`Checkpoint` å¯¹è±¡çš„çŠ¶æ€åœ¨æ‰«æè¿‡ç¨‹ä¸­ä¸æ–­æ›´æ–°ï¼š

```mermaid
stateDiagram-v2
[*] --> åˆå§‹åŒ–
åˆå§‹åŒ– --> åŠ è½½ : load_checkpoint()
åŠ è½½ --> å¤„ç†ä¸­ : å¼€å§‹æ‰«æ
å¤„ç†ä¸­ --> æ›´æ–°æ—¶é—´ : update_scan_time()
å¤„ç†ä¸­ --> æ·»åŠ SHA : add_scanned_sha()
å¤„ç†ä¸­ --> æ·»åŠ æŸ¥è¯¢ : add_processed_query()
å¤„ç†ä¸­ --> ä¿å­˜ : save_checkpoint()
ä¿å­˜ --> å¤„ç†ä¸­
å¤„ç†ä¸­ --> ä¿å­˜å¹¶é€€å‡º : ç”¨æˆ·ä¸­æ–­
ä¿å­˜å¹¶é€€å‡º --> [*]
```

**å›¾ç¤ºæ¥æº**
- [file_manager.py](file://utils/file_manager.py#L12-L48)

**æœ¬èŠ‚æ¥æº**
- [file_manager.py](file://utils/file_manager.py#L12-L48)

## é”™è¯¯å¤„ç†ä¸æ€§èƒ½ä¼˜åŒ–

### å¯†é’¥éªŒè¯æœºåˆ¶

`validate_gemini_key()` å‡½æ•°å®ç°äº†å¥å£®çš„å¯†é’¥éªŒè¯é€»è¾‘ï¼š

```python
def validate_gemini_key(api_key: str) -> Union[bool, str]:
    try:
        # éšæœºå»¶è¿Ÿé¿å…çªå‘è¯·æ±‚
        time.sleep(random.uniform(0.5, 1.5))

        # æ”¯æŒä»£ç†é…ç½®
        proxy_config = Config.get_random_proxy()
        if proxy_config:
            os.environ['grpc_proxy'] = proxy_config.get('http')

        genai.configure(api_key=api_key)
        model = genai.GenerativeModel(Config.HAJIMI_CHECK_MODEL)
        response = model.generate_content("hi")
        return "ok"
    except google_exceptions.TooManyRequests as e:
        return "rate_limited"
    except (google_exceptions.PermissionDenied, google_exceptions.Unauthenticated) as e:
        return "not_authorized_key"
    except Exception as e:
        if "429" in str(e) or "rate limit" in str(e).lower():
            return "rate_limited:429"
        elif "403" in str(e) or "SERVICE_DISABLED" in str(e):
            return "disabled"
        else:
            return f"error:{e.__class__.__name__}"
```

### æ€§èƒ½ä¼˜åŒ–æªæ–½

1. **éšæœºå»¶è¿Ÿ**: åœ¨è¯·æ±‚é—´æ·»åŠ éšæœºå»¶è¿Ÿï¼Œé¿å…è§¦å‘é€Ÿç‡é™åˆ¶
2. **å¤šä»¤ç‰Œè½®æ¢**: ä½¿ç”¨å¤šä¸ªGitHubä»¤ç‰Œåˆ†æ•£è¯·æ±‚
3. **ä»£ç†æ”¯æŒ**: æ”¯æŒé…ç½®ä»£ç†æœåŠ¡å™¨
4. **å¢é‡æ‰«æ**: é€šè¿‡checkpointå®ç°æ–­ç‚¹ç»­ä¼ 
5. **æ™ºèƒ½è¿‡æ»¤**: é€šè¿‡å¤šç§ç­–ç•¥å‡å°‘æ— æ•ˆå¤„ç†

### æ—¥å¿—æ¨¡å—é‡æ„

æ ¹æ®æäº¤ `edd314dab04a8b79c67ce8761837a874cbbf0b3c` çš„æ›´æ”¹ï¼Œæ—¥å¿—æ¨¡å—å·²é‡æ„ä»¥æå‡æ—¥å¿—è¾“å‡ºä½“éªŒå’ŒåŠŸèƒ½ã€‚ä¸»è¦å˜æ›´åŒ…æ‹¬ï¼š

- **æ—¥å¿—æ–‡ä»¶æŒ‰å¤©å½’æ¡£**: æ—¥å¿—æ–‡ä»¶ç°åœ¨æŒ‰å¤©å½’æ¡£ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º `app_YYYYMMDD.log`ï¼Œä¾¿äºç®¡ç†å’Œæ£€ç´¢ç‰¹å®šæ—¥æœŸçš„æ—¥å¿—ã€‚
- **å¢å¼ºçš„æ—¥å¿—æ ¼å¼**: æ·»åŠ äº†é¢œè‰²ç¼–ç å’Œå›¾æ ‡ä»¥æé«˜å¯è¯»æ€§ï¼Œä¸åŒæ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸åŒçš„é¢œè‰²å’Œå›¾æ ‡ã€‚
- **ä¸°å¯Œçš„æ—¥å¿—æ–¹æ³•**: æ–°å¢äº†ç‰¹å®šç”¨é€”çš„æ—¥å¿—æ–¹æ³•ï¼Œå¦‚ `success()`ã€`progress()`ã€`network()`ã€`file_op()`ã€`security()` å’Œ `rate_limit()`ï¼Œä½¿æ—¥å¿—æ›´å…·è¯­ä¹‰æ€§ã€‚
- **è¿›åº¦æ¡æ”¯æŒ**: `progress()` æ–¹æ³•æ”¯æŒæ˜¾ç¤ºè¿›åº¦æ¡ï¼Œä¾¿äºç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ã€‚
- **åˆ†éš”çº¿æ”¯æŒ**: `separator()` æ–¹æ³•å¯ç”¨äºåœ¨æ—¥å¿—ä¸­åˆ›å»ºåˆ†éš”çº¿ï¼Œæé«˜æ—¥å¿—çš„å¯è¯»æ€§ã€‚

**æ›´æ–°** æ—¥å¿—æ¨¡å—çš„é‡æ„æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œè°ƒè¯•æ•ˆç‡ã€‚

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L308-L341)
- [github_client.py](file://utils/github_client.py#L50-L150)
- [Logger.py](file://common/Logger.py) - *åœ¨æäº¤ edd314dab04a8b79c67ce8761837a874cbbf0b3c ä¸­æ›´æ–°*

## OpenRouterå¯†é’¥æå–æœºåˆ¶

### OpenRouterå¯†é’¥æå–

ç³»ç»Ÿé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æå–ç¬¦åˆç‰¹å®šæ¨¡å¼çš„OpenRouterå¯†é’¥ï¼Œå¹¶ç»“åˆä¸Šä¸‹æ–‡éªŒè¯å‡å°‘è¯¯æŠ¥ã€‚

```python
def extract_openrouter_keys(content: str) -> List[str]:
    """
    å½“åŒä¸€æ–‡ä»¶ä¸­åŒ…å« Config.OPENROUTER_BASE_URLS ä»»ä¸€å€¼æ—¶ï¼Œæå– OpenRouter API keysã€‚
    OpenRouter key æ ¼å¼: sk-or-v1-[64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²]
    å—æ§äºä»¥ä¸‹é…ç½®ï¼š
      - OPENROUTER_BASE_URLS
      - OPENROUTER_USE_LOOSE_PATTERN (bool)
      - OPENROUTER_PROXIMITY_CHARS (int, å½“ä½¿ç”¨å®½æ¾æ¨¡å¼æ—¶å»ºè®®>0)
      - OPENROUTER_REQUIRE_KEY_CONTEXT (bool)
    """
    base_urls = Config.OPENROUTER_BASE_URLS
    has_base, base_positions = _contains_base_url(content, base_urls)
    if not has_base:
        return []

    # OpenRouter key æ­£åˆ™æ¨¡å¼
    # ä¸¥æ ¼æ¨¡å¼ï¼šsk-or-v1-[64ä½åå…­è¿›åˆ¶]
    strict_pat = r'\bsk-or-v1-[0-9a-f]{64}\b'
    # å®½æ¾æ¨¡å¼ï¼šsk-or-v1-[è‡³å°‘40ä½å­—ç¬¦]
    loose_pat = r'\bsk-or-v1-[0-9a-f]{40,}\b'
    
    use_loose = Config.parse_bool(Config.OPENROUTER_USE_LOOSE_PATTERN)
    pattern = loose_pat if use_loose else strict_pat

    proximity_chars = Config.OPENROUTER_PROXIMITY_CHARS if use_loose else 0
    require_ctx = Config.parse_bool(Config.OPENROUTER_REQUIRE_KEY_CONTEXT)
    ctx_re = re.compile(r"(key|token|secret|authorization|api[-_ ]?key|openrouter)", re.IGNORECASE)

    results: List[str] = []
    for m in re.finditer(pattern, content, re.IGNORECASE):
        k = m.group(0)
        
        # è¿‡æ»¤æ˜æ˜¾çš„å ä½ç¬¦
        if "0000000000000000" in k.lower() or "your_key" in k.lower() or "example" in k.lower():
            continue

        # é‚»è¿‘æ€§æ£€æŸ¥ï¼ˆå½“ä½¿ç”¨å®½æ¾æ¨¡å¼æ—¶ï¼‰
        if proximity_chars and base_positions:
            pos = m.start()
            near = any(abs(pos - bp) <= proximity_chars for bp in base_positions)
            if not near:
                continue

        # ä¸Šä¸‹æ–‡æ£€æŸ¥ï¼ˆå½“å¯ç”¨æ—¶ï¼‰
        if require_ctx:
            start = max(0, m.start() - 80)
            end = min(len(content), m.end() + 80)
            snippet = content[start:end]
            if not ctx_re.search(snippet):
                continue

        results.append(k)

    # å»é‡ä¸”ä¿åº
    seen = set()
    deduped = [x for x in results if not (x in seen or seen.add(x))]
    return deduped
```

**æœ¬èŠ‚æ¥æº**
- [hajimi_king.py](file://app/hajimi_king.py#L160-L210)

## OpenRouterä¸“ç”¨æ‰«ææ¨¡å¼

### ä¸“ç”¨å¯åŠ¨è„šæœ¬

ç³»ç»Ÿæä¾›äº†ä¸“ç”¨çš„å¯åŠ¨è„šæœ¬ `start_openrouter_only.py`ï¼Œç”¨äºä¸“é—¨æ‰«æå’Œæå–OpenRouter APIå¯†é’¥ã€‚

```python
def main():
    """å¯åŠ¨ OpenRouter ä¸“ç”¨æ‰«æ"""
    logger.info("ğŸ”¥ å¯åŠ¨ OpenRouter ä¸“ç”¨æ‰«ææ¨¡å¼")
    logger.info("ğŸ“‹ é…ç½®è¯´æ˜ï¼š")
    logger.info("   - åªæ‰«æ OpenRouter API å¯†é’¥")
    logger.info("   - ä¸æ‰«æ ModelScope æˆ– Gemini å¯†é’¥")
    logger.info("   - ä¸è¿›è¡Œå¯†é’¥éªŒè¯ï¼Œä»…æå–å’Œä¿å­˜")
    logger.separator()
    
    # è®¾ç½® OpenRouter ä¸“ç”¨ç¯å¢ƒå˜é‡
    os.environ['OPENROUTER_EXTRACT_ONLY'] = 'true'
    os.environ['MODELSCOPE_EXTRACT_ONLY'] = 'false'
    os.environ['TARGET_BASE_URLS'] = ''  # ç¦ç”¨ ModelScope
    
    # ç¡®ä¿æœ‰ OpenRouter é…ç½®
    if not os.environ.get('OPENROUTER_BASE_URLS'):
        os.environ['OPENROUTER_BASE_URLS'] = 'https://openrouter.ai/api/v1,openrouter.ai'
        logger.info("âœ… è‡ªåŠ¨è®¾ç½® OpenRouter base URLs")
    
    # å¯¼å…¥å¹¶è¿è¡Œä¸»ç¨‹åº
    try:
        from app.hajimi_king import main as hajimi_main
        # é€šè¿‡ sys.argv ä¼ é€’å‘½ä»¤è¡Œå‚æ•°
        sys.argv.extend(['--mode', 'openrouter-only'])
        hajimi_main()
    except ImportError as e:
        logger.error(f"âŒ å¯¼å…¥é”™è¯¯: {e}")
        logger.info("è¯·ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼špip install -r requirements.txt")
    except Exception as e:
        logger.error(f"âŒ è¿è¡Œé”™è¯¯: {e}")
```

### å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ

`hajimi_king.py` æ”¯æŒ `--mode` å‘½ä»¤è¡Œå‚æ•°ï¼Œå®ç°ä¸åŒçš„æå–æ¨¡å¼ï¼š

```python
def _parse_cli_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Hajimi King")
    parser.add_argument(
        "--mode",
        choices=["modelscope-only", "openrouter-only", "compatible"],
        help="modelscope-only: ä»…æå– ms-keyï¼Œä¸å›é€€åˆ° Geminiï¼›openrouter-only: ä»…æå– OpenRouter keyï¼›compatible: æœªå‘½ä¸­æ—¶å›é€€åˆ°åŸæœ‰é€»è¾‘",
    )
    return parser.parse_args()
```

å½“ä½¿ç”¨ `--mode openrouter-only` æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. å¯ç”¨ `OPENROUTER_EXTRACT_ONLY` æ¨¡å¼
2. ç¦ç”¨ `MODELSCOPE_EXTRACT_ONLY` æ¨¡å¼
3. æ¸…ç©º `TARGET_BASE_URLS` ä»¥ç¡®ä¿ä¸æå–ModelScopeå¯†é’¥
4. ä»…æå–OpenRouterå¯†é’¥ï¼Œä¸è¿›è¡Œä»»ä½•éªŒè¯

**æœ¬èŠ‚æ¥æº**
- [start_openrouter_only.py](file://start_openrouter_only.py)
- [hajimi_king.py](file://app/hajimi_king.py#L426-L590)
- [OPENROUTER_USAGE.md](file://OPENROUTER_USAGE.md)